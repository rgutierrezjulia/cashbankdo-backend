<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="description" content="Todas las ofertas de cashback y descuentos de bancos dominicanos en un solo lugar. Actualizado diariamente.">
<title>CashbackDO ‚Äî Ofertas de Cashback de Bancos en RD</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="CashbackDO">
<meta name="application-name" content="CashbackDO">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#2563eb">

<!-- Manifest & Icons -->
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/svg+xml" href="./icon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">

<!-- iOS Splash Screens (inline SVG data URIs) -->
<link rel="apple-touch-startup-image"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 375 667'%3E%3Crect width='375' height='667' fill='%23f4f5f7'/%3E%3Ctext x='187' y='310' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='48' fill='%232563eb'%3ECB%3C/text%3E%3Ctext x='187' y='370' text-anchor='middle' font-family='system-ui' font-weight='700' font-size='22' fill='%23059669'%3EDO%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-startup-image"
      media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 390 844'%3E%3Crect width='390' height='844' fill='%23f4f5f7'/%3E%3Ctext x='195' y='390' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='48' fill='%232563eb'%3ECB%3C/text%3E%3Ctext x='195' y='450' text-anchor='middle' font-family='system-ui' font-weight='700' font-size='22' fill='%23059669'%3EDO%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-startup-image"
      media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 393 852'%3E%3Crect width='393' height='852' fill='%23f4f5f7'/%3E%3Ctext x='196' y='395' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='48' fill='%232563eb'%3ECB%3C/text%3E%3Ctext x='196' y='455' text-anchor='middle' font-family='system-ui' font-weight='700' font-size='22' fill='%23059669'%3EDO%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-startup-image"
      media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 430 932'%3E%3Crect width='430' height='932' fill='%23f4f5f7'/%3E%3Ctext x='215' y='435' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='48' fill='%232563eb'%3ECB%3C/text%3E%3Ctext x='215' y='495' text-anchor='middle' font-family='system-ui' font-weight='700' font-size='22' fill='%23059669'%3EDO%3C/text%3E%3C/svg%3E">

<!-- Google AdSense: uncomment and replace with your publisher ID
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
-->
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f4f5f7;
    --surface: #ffffff;
    --surface2: #eef0f3;
    --border: rgba(0,0,0,0.08);
    --accent: #2563eb;
    --accent2: #7c3aed;
    --accent3: #dc2626;
    --accent4: #d97706;
    --text: #1a1a2e;
    --muted: #6b7280;
    --card: #ffffff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* PWA safe area for iOS standalone mode */
  @supports (padding-top: env(safe-area-inset-top)) {
    header { padding-top: env(safe-area-inset-top); }
    body { padding-bottom: env(safe-area-inset-bottom); }
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 1000; opacity: 0.15;
  }

  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border); padding: 0 24px;
  }
  .header-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 60px; }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.3rem; letter-spacing: -0.03em; }
  .logo span { color: #059669; }
  .header-right { display: flex; align-items: center; gap: 10px; }

  .sync-info {
    font-size: 0.72rem; color: var(--muted);
    display: flex; align-items: center; gap: 6px;
  }
  .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: blink 2s infinite; }
  @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
  .sync-dot.stale { background: var(--accent4); animation: none; }
  .sync-dot.error { background: var(--accent3); animation: none; }

  .scrape-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 5px 12px; border-radius: 7px;
    font-size: 0.75rem; cursor: pointer; transition: all 0.18s;
    font-family: 'DM Sans', sans-serif; display: flex; align-items: center; gap: 5px;
  }
  .scrape-btn:hover { border-color: var(--accent); color: var(--accent); }
  .scrape-btn.loading { opacity: 0.6; cursor: not-allowed; }
  .scrape-btn .spin { display: none; animation: spin 1s linear infinite; }
  .scrape-btn.loading .spin { display: inline; }
  .scrape-btn.loading .idle { display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .hero { max-width: 1100px; margin: 0 auto; padding: 48px 24px 32px; }
  .hero h1 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: clamp(2rem, 5vw, 3.2rem); line-height: 1.1; letter-spacing: -0.03em; margin-bottom: 12px; }
  .hero h1 em { font-style: normal; color: var(--accent); }
  .hero p { color: var(--muted); font-size: 0.95rem; max-width: 480px; line-height: 1.6; }

  .stats-row { max-width: 1100px; margin: 0 auto 32px; padding: 0 24px; display: flex; gap: 12px; flex-wrap: wrap; }
  .stat-chip { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px 20px; flex: 1; min-width: 130px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .stat-chip .num { font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .stat-chip .lbl { font-size: 0.75rem; color: var(--muted); }
  .stat-chip.green .num { color: #059669; }
  .stat-chip.yellow .num { color: #b45309; }
  .stat-chip.purple .num { color: var(--accent2); }
  .stat-chip.blue .num { color: var(--accent); }

  .controls { max-width: 1100px; margin: 0 auto 24px; padding: 0 24px; display: flex; flex-direction: column; gap: 10px; }
  .filter-sort-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
  .filter-sort-row .cat-filter { flex: 1; }
  .cat-filter { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
  .cat-filter::-webkit-scrollbar { display: none; }
  .cat-btn { padding: 7px 16px; border-radius: 99px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 0.82rem; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.18s; white-space: nowrap; flex-shrink: 0; }
  .cat-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 600; }
  .mis-bank-btn { border-color: var(--accent2) !important; color: var(--accent2) !important; }
  .fav-bank-btn { border-color: #e11d48 !important; color: #e11d48 !important; }
  .hidden-bank-btn { border-color: var(--muted) !important; color: var(--muted) !important; }

  /* Heart toggle on cards */
  .card-fav-btn {
    background: none; border: none; cursor: pointer;
    padding: 4px; line-height: 0; transition: transform 0.2s;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  }
  .card-fav-btn:active { transform: scale(1.3); }
  .card-fav-btn.faved { animation: heartPop 0.3s ease; }
  @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

  /* Swipe-to-hide card wrapper */
  .card-swipe-wrap {
    position: relative; overflow: hidden; border-radius: 16px;
  }
  .card-swipe-wrap .swipe-bg {
    position: absolute; top: 0; bottom: 0; right: 0; width: 80px;
    background: var(--muted); display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 0.75rem; font-weight: 600; border-radius: 0 16px 16px 0;
    opacity: 0; transition: opacity 0.15s;
  }
  .card-swipe-wrap.swiping .swipe-bg { opacity: 1; }
  .card-swipe-wrap .promo-card {
    position: relative; z-index: 1; transition: transform 0.25s ease;
  }
  .card-swipe-wrap.hiding .promo-card {
    transform: translateX(-100%); transition: transform 0.3s ease;
  }
  .card-swipe-wrap.hiding {
    max-height: 300px; transition: max-height 0.3s ease 0.15s, opacity 0.3s ease;
    overflow: hidden;
  }
  .card-swipe-wrap.hiding.collapse { max-height: 0; opacity: 0; margin-bottom: 0; }
  /* Sort dropdown */
  .sort-row { display: flex; align-items: center; gap: 8px; }
  .sort-select {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 99px;
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem;
    padding: 6px 14px; cursor: pointer; outline: none; transition: border-color 0.18s;
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b6b88'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px;
  }
  .sort-select:focus { border-color: var(--accent); }
  .sort-select option { background: var(--surface2); color: var(--text); }

  .bank-filter { display: flex; gap: 6px; flex-wrap: wrap; }
  .bank-btn { padding: 5px 12px; border-radius: 99px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 0.75rem; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.18s; white-space: nowrap; }
  .bank-btn.active-all { background: var(--surface2); border-color: var(--text); color: var(--text); }

  .main { max-width: 1200px; margin: 0 auto; padding: 0 24px 60px; }

  /* Google Ads ‚Äî responsive leaderboard */
  .ad-container { width: 100%; margin-bottom: 20px; }
  .ad-slot {
    width: 100%; min-height: 90px; max-width: 728px; margin: 0 auto;
    background: var(--surface); border-radius: 12px; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }
  .ad-slot ins { display: block; width: 100%; }
  .ad-placeholder {
    width: 100%; height: 90px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 4px;
    color: var(--muted); font-size: 0.68rem; letter-spacing: 0.05em;
    text-transform: uppercase; opacity: 0.5;
  }
  .ad-placeholder-line { width: 60px; height: 1px; background: var(--border); }
  /* In-feed ad between cards */
  .ad-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    overflow: hidden; display: flex; align-items: center; justify-content: center;
    min-height: 250px;
  }
  .ad-card ins { display: block; width: 100%; }

  /* Promos grid ‚Äî 3 columns desktop */
  .cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  @media (max-width: 900px) { .cards-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; } }
  @media (max-width: 600px) { .cards-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; } }

  /* Drawer backdrop */
  .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
  .drawer-overlay.open { opacity: 1; pointer-events: all; }

  /* Slide-in drawer (right) */
  .side-drawer { position: fixed; top: 0; right: 0; bottom: 0; width: min(400px, 100vw); background: var(--surface); border-left: 1px solid var(--border); z-index: 201; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; overflow-y: auto; }
  .side-drawer.open { transform: translateX(0); }
  .drawer-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface); z-index: 1; }
  .drawer-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
  .drawer-close { background: none; border: none; color: var(--muted); font-size: 1.3rem; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: color 0.15s; }
  .drawer-close:hover { color: var(--text); }
  .drawer-body { padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 20px; }

  /* Settings dropdown */
  .settings-dropdown { position: fixed; top: 68px; right: 24px; width: min(340px, calc(100vw - 32px)); background: var(--surface); border: 1px solid var(--border); border-radius: 16px; z-index: 300; box-shadow: 0 20px 60px rgba(0,0,0,0.15); display: none; padding: 16px; }
  .settings-dropdown.open { display: block; animation: fadeDown 0.18s ease; }
  @keyframes fadeDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }

  /* Header drawer/settings buttons */
  .icon-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.18s; font-family: 'DM Sans', sans-serif; white-space: nowrap; }
  .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
  .icon-btn.active { border-color: var(--accent2); color: var(--accent2); background: rgba(124,92,255,0.1); }
  .promo-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; transition: all 0.22s; position: relative; overflow: hidden; animation: fadeUp 0.4s ease both; box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06); }
  .promo-card:hover { border-color: rgba(0,0,0,0.12); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .promo-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; border-radius: 16px 16px 0 0; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .bank-tag { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; font-weight: 500; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
  .bank-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .pct-badge { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.4rem; color: #059669; line-height: 1; }
  .pct-badge small { font-size: 0.65rem; font-weight: 400; color: var(--muted); display: block; text-align: right; font-family: 'DM Sans', sans-serif; }
  .card-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; margin-bottom: 8px; line-height: 1.3; text-align: left; }
  .card-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.5; margin-bottom: 14px; }
  .card-meta { display: flex; flex-wrap: wrap; gap: 8px; }
  .meta-chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 5px 10px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; color: var(--muted); }
  .meta-chip .val { color: var(--text); font-weight: 500; }
  .meta-chip.hl { border-color: rgba(5,150,105,0.25); background: rgba(5,150,105,0.06); }
  .meta-chip.hl .val { color: #059669; }
  .card-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
  .validity { font-size: 0.75rem; color: var(--muted); display: flex; align-items: center; gap: 5px; }
  .days-badge { border-radius: 5px; padding: 2px 7px; font-weight: 500; font-size: 0.72rem; }
  .days-badge.active { background: rgba(5,150,105,0.1); color: #059669; }
  .days-badge.soon { background: rgba(217,119,6,0.1); color: #b45309; }
  .days-badge.expired { background: rgba(220,38,38,0.08); color: var(--accent3); }
  .card-link { font-size: 0.75rem; color: var(--muted); text-decoration: none; padding: 5px 12px; border: 1px solid var(--border); border-radius: 7px; transition: all 0.18s; }
  .card-link:hover { border-color: var(--accent); color: var(--accent); }
  .tags-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
  .tag { font-size: 0.68rem; padding: 3px 8px; border-radius: 5px; font-weight: 500; }
  .tag.online { background: rgba(124,58,237,0.1); color: var(--accent2); }
  .tag.presencial { background: rgba(37,99,235,0.1); color: var(--accent); }
  .tag.a√©reo { background: rgba(217,119,6,0.1); color: var(--accent4); }
  .tag.entretenimiento { background: rgba(220,38,38,0.1); color: var(--accent3); }
  .tag.supermercado,.tag.restaurante { background: rgba(5,150,105,0.1); color: #059669; }
  .tag.cr√©dito { background: rgba(37,99,235,0.08); color: var(--accent); }
  .tag.d√©bito { background: rgba(0,0,0,0.05); color: var(--muted); }

  /* Widget (used inside drawers) */

  /* ‚ïê‚ïê‚ïê Hamburger menu (mobile only) ‚ïê‚ïê‚ïê */
  .hamburger-btn {
    display: none; background: none; border: none; color: var(--text);
    font-size: 1.4rem; cursor: pointer; padding: 6px; line-height: 1;
  }
  .mobile-menu {
    display: none; position: fixed; top: 0; right: 0; bottom: 0;
    width: min(280px, 80vw); background: var(--surface); border-left: 1px solid var(--border);
    z-index: 400; transform: translateX(100%); transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
    flex-direction: column; padding: 0;
  }
  .mobile-menu.open { transform: translateX(0); }
  .mobile-menu-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    z-index: 399; opacity: 0; pointer-events: none; transition: opacity 0.25s;
  }
  .mobile-menu-overlay.open { opacity: 1; pointer-events: all; }
  .mobile-menu-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
  }
  .mobile-menu-header .logo { font-size: 1.1rem; }
  .mobile-menu-close { background: none; border: none; color: var(--muted); font-size: 1.3rem; cursor: pointer; padding: 4px 8px; }
  .mobile-menu-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 4px; flex: 1; overflow-y: auto; }
  .mobile-menu-item {
    display: flex; align-items: center; gap: 12px; padding: 14px 16px;
    border-radius: 12px; background: none; border: none; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem; cursor: pointer;
    transition: background 0.15s; text-align: left; width: 100%;
  }
  .mobile-menu-item:hover, .mobile-menu-item:active { background: var(--surface2); }
  .mobile-menu-item .menu-icon { font-size: 1.1rem; width: 28px; text-align: center; }
  .mobile-menu-divider { height: 1px; background: var(--border); margin: 8px 0; }
  .mobile-menu-sync {
    padding: 12px 16px; font-size: 0.75rem; color: var(--muted);
    display: flex; align-items: center; gap: 8px;
  }
  .mobile-menu-sync .sync-dot { width: 6px; height: 6px; border-radius: 50%; }

  /* ‚ïê‚ïê‚ïê Mobile: iPhone-optimized layout ‚ïê‚ïê‚ïê */
  @media (max-width: 600px) {
    /* Header: just logo + hamburger */
    .header-inner { height: 50px; padding: 0; }
    .logo { font-size: 1.1rem; }
    .header-right .sync-info,
    .header-right .scrape-btn,
    .header-right .icon-btn { display: none; }
    .hamburger-btn { display: block; }
    .mobile-menu { display: flex; }
    .mobile-menu-overlay { display: block; }

    /* Hero: hidden on mobile */
    .hero { display: none; }

    /* API banner: hidden on mobile */
    .api-banner { display: none !important; }

    /* Stats: single row, 4 compact chips */
    .stats-row { margin-top: 10px; margin-bottom: 12px; gap: 6px; display: flex; flex-wrap: nowrap; padding: 0 16px; }
    .stat-chip { padding: 8px 0; min-width: 0; flex: 1; text-align: center; border-radius: 10px; }
    .stat-chip .num { font-size: 1rem; }
    .stat-chip .lbl { font-size: 0.58rem; }

    /* Filters ‚Äî wrap, sort on right */
    .controls { margin-bottom: 12px; gap: 8px; padding: 0 16px; }
    .filter-sort-row { flex-direction: column; gap: 8px; }
    .filter-sort-row .cat-filter { flex-wrap: wrap; overflow-x: visible; gap: 6px; }
    .filter-sort-row .sort-select { align-self: flex-end; }
    .cat-btn { padding: 5px 11px; font-size: 0.72rem; }
    .sort-select { font-size: 0.75rem; padding: 5px 26px 5px 12px; }
    /* Show only the 4 main filters, justified evenly */
    .bank-filter { display: flex; gap: 0; justify-content: stretch; }
    .bank-filter .bank-btn:not([data-bank="all"]):not([data-bank="mis-productos"]):not([data-bank="favoritos"]):not([data-bank="hidden"]) { display: none; }
    .bank-filter .bank-btn { flex: 1; text-align: center; justify-content: center; padding: 7px 4px; font-size: 0.72rem; border-radius: 0; border-right: none; }
    .bank-filter .bank-btn:first-child { border-radius: 10px 0 0 10px; }
    .bank-filter .bank-btn:last-of-type, .bank-filter .bank-btn[data-bank="hidden"] { border-radius: 0 10px 10px 0; border-right: 1px solid var(--border); }

    /* Ads */
    .ad-container { margin-bottom: 14px; }
    .ad-slot { min-height: 50px; border-radius: 10px; }
    .ad-placeholder { height: 50px; }
    .ad-card { min-height: 200px; border-radius: 14px; }

    /* Main */
    .main { padding: 0 16px 40px; }

    /* Cards: SINGLE COLUMN for readability */
    .cards-grid { grid-template-columns: 1fr !important; gap: 12px; }

    /* Promo card: compact by default, expandable */
    .promo-card { padding: 14px 16px; border-radius: 14px; cursor: pointer; }
    .card-top { margin-bottom: 6px; }
    .bank-tag { font-size: 0.72rem; gap: 6px; }
    .bank-dot { width: 7px; height: 7px; }
    .pct-badge { font-size: 1.3rem; }
    .pct-badge small { font-size: 0.6rem; }
    .card-title { font-size: 0.88rem; line-height: 1.3; margin-bottom: 0; }

    /* Hidden by default on mobile ‚Äî shown on expand */
    .card-desc, .tags-row, .card-meta, .card-notes-wrap, .card-link { display: none; }
    .card-bottom { margin-top: 8px; padding-top: 8px; }
    .days-badge { font-size: 0.7rem; padding: 2px 8px; }
    .card-expand-hint { font-size: 0.65rem; color: var(--muted); }

    /* Expanded state */
    .promo-card.expanded .card-title { margin-bottom: 6px; }
    .promo-card.expanded .card-desc { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-size: 0.78rem; line-height: 1.5; margin-bottom: 10px; }
    .promo-card.expanded .tags-row { display: flex; margin-bottom: 8px; }
    .promo-card.expanded .card-meta { display: flex; gap: 6px; }
    .promo-card.expanded .meta-chip { font-size: 0.7rem; padding: 4px 8px; }
    .promo-card.expanded .card-notes-wrap { display: block; }
    .promo-card.expanded .card-link { display: flex; font-size: 0.72rem; padding: 6px 12px; min-height: 32px; align-items: center; }
    .promo-card.expanded .card-expand-hint { display: none; }

    /* Settings dropdown full-width on mobile */
    .settings-dropdown { right: 8px; left: 8px; width: auto; top: 56px; }

    /* Hide text labels on mobile, keep icons */
    .hide-mobile { display: none; }
  }

  .add-card-form { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
  .add-btn { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 9px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: opacity 0.18s; }
  .add-btn:hover { opacity: 0.85; }

  /* Settings sections */
  .settings-section { margin-bottom: 20px; }
  .settings-section-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px; }
  .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .settings-item:last-child { border-bottom: none; }
  .settings-item-left { flex: 1; min-width: 0; }
  .settings-item-label { font-size: 0.85rem; font-weight: 500; margin-bottom: 2px; }
  .settings-item-desc { font-size: 0.7rem; color: var(--muted); line-height: 1.4; }
  .settings-item-icon { font-size: 1.1rem; margin-right: 12px; flex-shrink: 0; }
  .settings-last-update { font-size: 0.72rem; color: var(--muted); text-align: center; padding: 8px 0; border-top: 1px solid var(--border); margin-top: 4px; }
  #notifSubToggles .settings-item-label { font-size: 0.82rem; }
  #notifSubToggles .settings-item-desc { font-size: 0.68rem; }
  #notifSubToggles .settings-item { padding: 10px 0; }

  /* iOS-style toggle switch */
  .toggle-switch { position: relative; width: 44px; height: 26px; flex-shrink: 0; margin-left: 12px; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; inset: 0; cursor: pointer; border-radius: 26px;
    background: #d1d5db; transition: background 0.25s;
  }
  .toggle-slider::before {
    content: ''; position: absolute; left: 2px; top: 2px;
    width: 22px; height: 22px; border-radius: 50%;
    background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    transition: transform 0.25s;
  }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); }
  .toggle-switch input:disabled + .toggle-slider { opacity: 0.4; cursor: not-allowed; }

  /* Location */
  .location-display { background: var(--surface2); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
  .location-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .location-name { font-size: 0.85rem; font-weight: 500; }
  .location-sub { font-size: 0.72rem; color: var(--muted); }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; position: relative; }
  .pulse-dot.active::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 1.5px solid var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1.8); opacity: 0; } }
  .timer-bar-wrap { margin-top: 8px; }
  .timer-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 4px; display: flex; justify-content: space-between; }
  .timer-bar { height: 4px; background: var(--surface); border-radius: 99px; overflow: hidden; }
  .timer-fill { height: 100%; background: var(--accent); border-radius: 99px; transition: width 1s linear; }
  .nearby-promo { background: linear-gradient(135deg, rgba(0,229,160,0.08), rgba(124,92,255,0.08)); border: 1px solid rgba(0,229,160,0.2); border-radius: 10px; padding: 12px; font-size: 0.8rem; line-height: 1.5; margin-bottom: 12px; }
  .nearby-promo strong { color: var(--accent); }

  /* Toast */
  .notif-toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px 20px; max-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); z-index: 9999; display: none; }
  .notif-toast.show { display: block; animation: slideIn 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes slideIn { from { transform: translateX(100%) translateY(20px); opacity: 0; } to { transform: translateX(0) translateY(0); opacity: 1; } }
  .notif-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .notif-bank { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent2); font-weight: 700; }
  .notif-msg { font-size: 0.82rem; line-height: 1.5; }
  .notif-sub { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
  .notif-close { position: absolute; top: 10px; right: 12px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; }

  /* Loading skeleton */
  .skeleton { background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
  @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }
  .sk-card { height: 180px; border-radius: 16px; margin-bottom: 14px; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .big { font-size: 3rem; margin-bottom: 12px; }

  /* Network badges */
  .net-badge { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 5px; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.03em; }
  .net-badge.visa { background: rgba(26,95,205,0.15); color: #5b9cf6; }
  .net-badge.mastercard { background: rgba(235,77,47,0.15); color: #f5856d; }
  .net-badge.amex { background: rgba(0,180,135,0.15); color: #2dce9b; }
  .type-badge { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 5px; font-size: 0.65rem; font-weight: 500; }
  .type-badge.credito { background: rgba(0,229,160,0.08); color: var(--accent); }
  .type-badge.debito { background: rgba(255,255,255,0.06); color: var(--muted); }

  /* Card item improved */
  .card-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .card-item:last-child { border-bottom: none; }
  .card-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .card-info { flex: 1; min-width: 0; }
  .card-name { font-size: 0.8rem; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-badges { display: flex; gap: 4px; flex-wrap: wrap; }
  .card-promos { font-size: 0.65rem; font-weight: 700; min-width: 20px; height: 20px; padding: 0 5px; border-radius: 99px; display: flex; align-items: center; justify-content: center; background: var(--accent); color: #fff; flex-shrink: 0; }
  .card-promos.zero { background: var(--surface2); color: var(--muted); }
  .card-del { background: none; border: none; color: var(--muted); cursor: pointer; padding: 3px 5px; border-radius: 5px; font-size: 0.8rem; flex-shrink: 0; transition: color 0.15s; }
  .card-del:hover { color: var(--accent3); }

  /* Apple Wallet import button */
  .wallet-import-btn { display: flex; align-items: center; justify-content: center; gap: 7px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px; color: var(--text); font-size: 0.82rem; cursor: pointer; transition: all 0.18s; font-family: 'DM Sans', sans-serif; width: 100%; }
  .wallet-import-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; width: 100%; max-width: 480px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
  .modal-header { padding: 20px 20px 14px; border-bottom: 1px solid var(--border); }
  .modal-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .modal-search { background: var(--surface2); border: 1px solid var(--border); border-radius: 9px; padding: 9px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; width: 100%; transition: border-color 0.18s; }
  .modal-search:focus { border-color: var(--accent); }
  .modal-list { flex: 1; overflow-y: auto; padding: 10px 12px; }
  .modal-item { display: flex; align-items: center; gap: 10px; padding: 9px 8px; border-radius: 9px; cursor: pointer; transition: background 0.15s; }
  .modal-item:hover { background: var(--surface2); }
  .modal-item input[type=checkbox] { accent-color: var(--accent); width: 15px; height: 15px; flex-shrink: 0; cursor: pointer; }
  .modal-item-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
  .modal-item-name { flex: 1; font-size: 0.82rem; }
  .modal-item-badges { display: flex; gap: 4px; }
  .modal-bank-header { font-size: 0.7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; padding: 12px 8px 4px; }
  .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 10px; }
  .modal-count { font-size: 0.82rem; color: var(--muted); }
  .modal-add-btn { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 9px 18px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: opacity 0.18s; }
  .modal-add-btn:hover { opacity: 0.85; }
  .modal-add-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .modal-close { background: none; border: none; color: var(--muted); font-size: 1.2rem; cursor: pointer; padding: 4px; }

  /* Add card form dropdowns row */
  .add-card-form select { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; transition: border-color 0.18s; width: 100%; }
  .add-card-form select:focus { border-color: var(--accent); }
  .add-card-form option { background: var(--surface); }

  /* API config banner */
  .api-banner { background: rgba(255,209,102,0.08); border: 1px solid rgba(255,209,102,0.2); border-radius: 12px; padding: 12px 16px; font-size: 0.8rem; color: var(--accent4); margin-bottom: 16px; line-height: 1.6; }
  .api-banner strong { display: block; margin-bottom: 4px; }
  .api-input-row { display: flex; gap: 8px; margin-top: 8px; }
  .api-input-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 7px; padding: 7px 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; outline: none; }
  .api-input-row button { background: var(--accent4); color: #000; border: none; border-radius: 7px; padding: 7px 12px; font-size: 0.78rem; font-weight: 700; cursor: pointer; font-family: 'Syne', sans-serif; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="logo">Cashback<span>DO</span></div>
    </div>
    <div class="header-right">
      <div class="sync-info">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncText">Conectando...</span>
      </div>
      <button class="scrape-btn" id="scrapeBtn" onclick="triggerScrape()">
        <span class="idle">üîÑ</span>
        <span class="spin">‚ü≥</span>
      </button>
      <button class="icon-btn" id="walletBtn" onclick="toggleWalletDrawer()">üí≥ <span class="hide-mobile">Mis Tarjetas</span></button>
      <button class="icon-btn" id="settingsBtn" onclick="toggleSettings()">‚öôÔ∏è</button>
      <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMobileMenu()">‚ò∞</button>
    </div>
  </div>
</header>

<!-- Mobile slide-in menu -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
<div class="mobile-menu" id="mobileMenu">
  <div class="mobile-menu-header">
    <div class="logo">Cashback<span>DO</span></div>
    <button class="mobile-menu-close" onclick="closeMobileMenu()">‚úï</button>
  </div>
  <div class="mobile-menu-body">
    <button class="mobile-menu-item" onclick="closeMobileMenu();toggleWalletDrawer()">
      <span class="menu-icon">üí≥</span> Mis Tarjetas
    </button>
    <button class="mobile-menu-item" onclick="closeMobileMenu();toggleSettings()">
      <span class="menu-icon">‚öôÔ∏è</span> Configuraciones
    </button>
  </div>
</div>

<div class="hero">
  <h1>Cashback <em>bancario</em><br>en Rep√∫blica Dominicana</h1>
  <p>Datos extra√≠dos autom√°ticamente cada d√≠a de las bases legales de todos los bancos dominicanos. Siempre actualizado.</p>
</div>

<div class="stats-row">
  <div class="stat-chip green"><div class="num" id="statActive">‚Äî</div><div class="lbl">Vigentes hoy</div></div>
  <div class="stat-chip yellow"><div class="num" id="statUpcoming">‚Äî</div><div class="lbl">Pr√≥ximos 15 d√≠as</div></div>
  <div class="stat-chip purple"><div class="num" id="statBanks">‚Äî</div><div class="lbl">Bancos</div></div>
  <div class="stat-chip blue"><div class="num" id="statTotal">‚Äî</div><div class="lbl">Total promos</div></div>
</div>

<div class="controls">
  <div class="filter-sort-row">
    <div class="cat-filter" id="catFilter">
      <button class="cat-btn active" onclick="setCategory('all',this)">Todas</button>
      <button class="cat-btn" onclick="setCategory('restaurante',this)">üçΩÔ∏è Restaurantes</button>
      <button class="cat-btn" onclick="setCategory('supermercado',this)">üõí Super</button>
      <button class="cat-btn" onclick="setCategory('shopping',this)">üõçÔ∏è Shopping</button>
      <button class="cat-btn" onclick="setCategory('viaje',this)">‚úàÔ∏è Viajes</button>
      <button class="cat-btn" onclick="setCategory('entretenimiento',this)">üé≠ Ocio</button>
      <button class="cat-btn" onclick="setCategory('educaci√≥n',this)">üìö Educaci√≥n</button>
      <button class="cat-btn" onclick="setCategory('otro',this)">üì¶ Otras</button>
    </div>
    <select class="sort-select" id="sortSelect" onchange="setSort(this.value)">
      <option value="" disabled selected>Ordenar</option>
      <option value="vigencia">Vigencia</option>
      <option value="cercania">Cercan√≠a</option>
      <option value="az">A‚ÄìZ</option>
      <option value="za">Z‚ÄìA</option>
    </select>
  </div>
  <div class="bank-filter" id="bankFilter">
    <button class="bank-btn mis-bank-btn" data-bank="mis-productos" onclick="setBank('mis-productos',this)">‚≠ê Mis Productos</button>
    <button class="bank-btn fav-bank-btn" data-bank="favoritos" onclick="setBank('favoritos',this)">‚ù§Ô∏è Favoritos</button>
    <button class="bank-btn active-all" data-bank="all" onclick="setBank('all',this)">Todos</button>
    <button class="bank-btn hidden-bank-btn" data-bank="hidden" onclick="setBank('hidden',this)">üôà Hidden</button>
  </div>
</div>

<div class="main">
  <div id="apiBanner" class="api-banner" style="display:none">
    <strong>‚öôÔ∏è Configura el servidor backend</strong>
    Ingresa la URL de tu servidor CashbackDO para ver las promos en vivo.
    <div class="api-input-row">
      <input id="apiUrlInput" type="text" placeholder="http://localhost:3001" />
      <button onclick="setApiUrl()">Conectar</button>
    </div>
  </div>

  <!-- Google AdSense: Top leaderboard (responsive) -->
  <div class="ad-container">
    <div class="ad-slot" id="adTop">
      <!--
        Replace this placeholder with your AdSense code:
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
             data-ad-slot="XXXXXXXXXX"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      -->
      <div class="ad-placeholder">
        <div class="ad-placeholder-line"></div>
        <span>Ad</span>
        <div class="ad-placeholder-line"></div>
      </div>
    </div>
  </div>

  <div class="cards-grid" id="cardsList">
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
  </div>
</div>

<!-- Drawer backdrop -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeAllDrawers()"></div>

<!-- Mis Tarjetas drawer -->
<div class="side-drawer" id="walletDrawer">
  <div class="drawer-header">
    <div class="drawer-title">üí≥ Mis Tarjetas</div>
    <button class="drawer-close" onclick="closeAllDrawers()">‚úï</button>
  </div>
  <div class="drawer-body">
    <div id="walletList"></div>
    <div class="add-card-form">
      <select id="cardBank" onchange="onBankChange()">
        <option value="">Banco...</option>
      </select>
      <select id="cardName" disabled>
        <option value="">Selecciona banco primero</option>
      </select>
      <button class="add-btn" onclick="addCard()">+ Agregar tarjeta</button>
      <button class="wallet-import-btn" onclick="openWalletModal()">üçé Importar desde Apple Wallet</button>
    </div>
  </div>
</div>

<!-- Settings dropdown -->
<div class="settings-dropdown" id="settingsDropdown">

  <!-- Location Services -->
  <div class="settings-section">
    <div class="settings-section-title">Ubicaci√≥n</div>
    <div class="settings-item">
      <span class="settings-item-icon">üìç</span>
      <div class="settings-item-left">
        <div class="settings-item-label">Servicios de ubicaci√≥n</div>
        <div class="settings-item-desc">Detecta promos cercanas autom√°ticamente</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="toggleLocation" onchange="onToggleLocation(this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <!-- Location status (shown when active) -->
    <div id="locationStatus" class="location-display" style="display:none;margin-top:8px">
      <div class="location-row">
        <div class="pulse-dot" id="pulseDot" style="background:var(--muted)"></div>
        <div>
          <div class="location-name" id="locName">Buscando ubicaci√≥n...</div>
          <div class="location-sub" id="locSub"></div>
        </div>
      </div>
      <div class="timer-bar-wrap" id="timerWrap" style="display:none">
        <div class="timer-label"><span>Tiempo en lugar</span><span id="timerLabel">0:00 / 5:00</span></div>
        <div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:0%"></div></div>
      </div>
    </div>
    <div id="nearbyPromo" style="display:none" class="nearby-promo"></div>
  </div>

  <!-- Notifications -->
  <div class="settings-section">
    <div class="settings-section-title">Notificaciones</div>
    <div class="settings-item">
      <span class="settings-item-icon">üîî</span>
      <div class="settings-item-left">
        <div class="settings-item-label">Permitir notificaciones</div>
        <div class="settings-item-desc">Activa las notificaciones push</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="toggleNotifMaster" onchange="onToggleNotifMaster(this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <!-- Sub-notifications (indented, enabled only when master is on) -->
    <div id="notifSubToggles" style="padding-left:32px;opacity:0.45;pointer-events:none;transition:opacity 0.2s">
      <div class="settings-item">
        <div class="settings-item-left">
          <div class="settings-item-label">Nuevas promos para mis tarjetas</div>
          <div class="settings-item-desc">Cuando se activa una promo para tus tarjetas</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleNotifNewPromos" onchange="onToggleNotifSub()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="settings-item">
        <div class="settings-item-left">
          <div class="settings-item-label">Promo cercana detectada</div>
          <div class="settings-item-desc">Al pasar 5 min cerca de un establecimiento</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleNotifNearby" onchange="onToggleNotifSub()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="settings-item">
        <div class="settings-item-left">
          <div class="settings-item-label">Favorita por vencer</div>
          <div class="settings-item-desc">Cuando una promo favorita est√° por expirar</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleNotifExpiring" onchange="onToggleNotifSub()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="settings-item">
        <div class="settings-item-left">
          <div class="settings-item-label">Promo actualizada</div>
          <div class="settings-item-desc">Cuando un banco modifica una promo existente</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="toggleNotifUpdated" onchange="onToggleNotifSub()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Last Updated -->
  <div class="settings-last-update" id="settingsLastUpdate">
    √öltima actualizaci√≥n: ‚Äî
  </div>
</div>

<!-- Apple Wallet Import Modal -->
<div class="modal-overlay" id="walletModal" onclick="closeWalletModalOutside(event)">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">
        üçé Importar desde Apple Wallet
        <button class="modal-close" onclick="closeWalletModal()" style="margin-left:auto">‚úï</button>
      </div>
      <input class="modal-search" id="modalSearch" type="text" placeholder="Buscar tarjeta..." oninput="filterModalCards()" />
    </div>
    <div class="modal-list" id="modalList"></div>
    <div class="modal-footer">
      <span class="modal-count" id="modalCount">0 seleccionadas</span>
      <button class="modal-add-btn" id="modalAddBtn" onclick="addModalSelected()" disabled>A√±adir seleccionadas</button>
    </div>
  </div>
</div>

<div class="notif-toast" id="notifToast">
  <button class="notif-close" onclick="closeToast()">‚úï</button>
  <div class="notif-header"><span>üîî</span><span class="notif-bank" id="toastBank"></span></div>
  <div class="notif-msg" id="toastMsg"></div>
  <div class="notif-sub" id="toastSub"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Sanitizar API_BASE: solo host, sin paths
const _savedApi = localStorage.getItem('cashbackdo_api') || 'https://cashbankdo-backend-production.up.railway.app';
let API_BASE = (() => { try { const u = new URL(_savedApi); return u.origin; } catch { return 'https://cashbankdo-backend-production.up.railway.app'; } })();
const ADMIN_KEY = localStorage.getItem('cashbackdo_adminkey') || '';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allPromos = [];
let banks = [];
let cardCatalog = {};
let activeCategory = 'all';
let activeBank = 'all';
let activeSort = 'vigencia';
let userLat = null;
let userLng = null;

// Mapeo de valor de categor√≠a a tags del backend
const CATEGORY_TAGS = {
  shopping:          ['retail', 'online'],
  supermercado:      ['supermercado', 'farmacia'],
  restaurante:       ['restaurante', 'bebidas'],
  entretenimiento:   ['entretenimiento'],
  viaje:             ['viaje'],
  'educaci√≥n':       ['educaci√≥n'],
  otro:              ['otro', 'combustible'],
};
let geoActive = false;
// Persist helper ‚Äî saves to localStorage and logs for debugging
function saveState(key, data) {
  try {
    const json = typeof data === 'string' ? data : JSON.stringify(data);
    localStorage.setItem(key, json);
  } catch (e) { console.warn('localStorage save failed:', key, e); }
}
function loadState(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (raw) return JSON.parse(raw);
  } catch (e) { console.warn('localStorage load failed:', key, e); }
  return fallback;
}

let walletCards = loadState('cashbackdo_wallet', []);
let favoriteIds = new Set(loadState('cashbackdo_favs', []));
let hiddenIds = new Set(loadState('cashbackdo_hidden', []));
// Modal state
let modalSelected = new Set();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API CALLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchPromos() {
  const params = new URLSearchParams();
  if (activeBank !== 'all' && activeBank !== 'mis-productos') params.append('bank', activeBank);
  const res = await fetch(`${API_BASE}/api/promos?${params}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchStats() {
  const res = await fetch(`${API_BASE}/api/stats`);
  if (!res.ok) throw new Error();
  return res.json();
}

async function fetchBanks() {
  const res = await fetch(`${API_BASE}/api/banks`);
  if (!res.ok) throw new Error();
  return res.json();
}

async function fetchCardCatalog() {
  try {
    const res = await fetch(`${API_BASE}/api/card-catalog`);
    if (!res.ok) { console.warn('card-catalog status:', res.status); return; }
    const data = await res.json();
    if (data && Object.keys(data).length > 0) {
      cardCatalog = data;
      populateBankSelect();
    } else {
      console.warn('card-catalog vino vac√≠o');
    }
  } catch (e) {
    console.error('fetchCardCatalog error:', e);
  }
}

function populateBankSelect() {
  const sel = document.getElementById('cardBank');
  sel.innerHTML = '<option value="">Banco...</option>' +
    Object.entries(cardCatalog).map(([id, bank]) =>
      `<option value="${id}">${bank.name}</option>`
    ).join('');
}

function onBankChange() {
  const bankId = document.getElementById('cardBank').value;
  const cardSel = document.getElementById('cardName');
  if (!bankId || !cardCatalog[bankId]) {
    cardSel.innerHTML = '<option value="">Selecciona banco primero</option>';
    cardSel.disabled = true;
    return;
  }
  const cards = cardCatalog[bankId].cards || [];
  cardSel.innerHTML = '<option value="">Tarjeta...</option>' +
    cards.map(c => `<option value="${c.id}" data-network="${c.network}" data-type="${c.type}">${c.name}</option>`).join('');
  cardSel.disabled = false;
}

async function matchWallet() {
  if (walletCards.length === 0) return [];
  const res = await fetch(`${API_BASE}/api/match-wallet`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cards: walletCards })
  });
  if (!res.ok) return [];
  const data = await res.json();
  return data.matches;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadData() {
  try {
    const [promosData, statsData, banksData] = await Promise.all([
      fetchPromos(), fetchStats(), fetchBanks()
    ]);

    allPromos = promosData.promos || [];
    banks = banksData;

    // If API returned 0 promos (e.g. during scrape), try local fallback
    if (allPromos.length === 0) {
      try {
        const fb = await fetch('../data/promos.json');
        if (fb.ok) {
          const fbData = await fb.json();
          if (fbData.promos?.length > 0) {
            allPromos = fbData.promos;
          }
        }
      } catch (e) { /* no fallback available */ }
    }

    // Update stats ‚Äî derive bank count from actual promos to stay accurate
    document.getElementById('statActive').textContent = promosData.meta?.stats?.active || allPromos.filter(p => p.isActive).length;
    document.getElementById('statUpcoming').textContent = promosData.meta?.stats?.upcoming || allPromos.filter(p => p.isUpcoming).length;
    const uniqueBanks = new Set(allPromos.map(p => p.bankId));
    document.getElementById('statBanks').textContent = uniqueBanks.size;
    document.getElementById('statTotal').textContent = promosData.meta?.stats?.total || allPromos.length;

    // Sync status
    setSyncStatus('ok', statsData.lastUpdated);

    // Bank filter buttons
    renderBankFilter(banksData);

    // Scrape stats widget
    renderScrapeStats(statsData);

    // Render cards
    renderCards();
    renderWallet();

    document.getElementById('apiBanner').style.display = 'none';
  } catch (err) {
    console.error('API error:', err);
    setSyncStatus('error', null);
    document.getElementById('apiBanner').style.display = 'block';
    document.getElementById('apiUrlInput').value = API_BASE;
    // Fallback: try loading local promos.json
    if (allPromos.length === 0) {
      const paths = ['../data/promos.json', 'data/promos.json', '/data/promos.json'];
      for (const path of paths) {
        try {
          const fallback = await fetch(path);
          if (fallback.ok) {
            const data = await fallback.json();
            allPromos = data.promos || [];
            break;
          }
        } catch (e) { /* try next path */ }
      }
    }
    renderCards();
  }
}

function setSyncStatus(status, lastUpdated) {
  const dot = document.getElementById('syncDot');
  const text = document.getElementById('syncText');
  dot.className = 'sync-dot';

  if (status === 'ok') {
    const ago = lastUpdated ? timeAgo(lastUpdated) : 'reci√©n';
    text.textContent = `Actualizado ${ago}`;
    dot.style.background = 'var(--accent)';
  } else if (status === 'error') {
    text.textContent = 'Sin conexi√≥n al servidor';
    dot.style.background = 'var(--accent3)';
  }
}

function timeAgo(iso) {
  const diff = Date.now() - new Date(iso);
  const h = Math.floor(diff / 3600000);
  const m = Math.floor(diff / 60000);
  if (h > 0) return `hace ${h}h`;
  if (m > 0) return `hace ${m}min`;
  return 'ahora mismo';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SMART CARD MATCHING FOR "MIS PRODUCTOS"
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Check if a promo is eligible for any card in the user's wallet
function isPromoEligibleForWallet(promo) {
  return walletCards.some(card => isCardEligible(card, promo));
}

// Check if a specific wallet card is eligible for a promo
function isCardEligible(card, promo) {
  // Step 1: Bank must match
  const cardBankId = card.bankId || card.bank?.toLowerCase().replace(/\s+/g, '');
  const bankMatch = promo.bankId === cardBankId ||
                    promo.bank?.toLowerCase().includes(card.bank?.toLowerCase()) ||
                    promo.bankId === card.bank?.toLowerCase();
  if (!bankMatch) return false;

  // Step 2: Card type must match (cr√©dito / d√©bito)
  const cardType = card.type || card.tipo || '';
  if (cardType && promo.cardTypes?.length > 0) {
    if (!promo.cardTypes.includes(cardType)) return false;
  }

  // Step 3: Check eligibleCards rules
  const eligible = promo.eligibleCards || [];
  if (eligible.length === 0) return true; // No restrictions = all cards from this bank

  const cardName = (card.name || '').toLowerCase();
  const cardNetwork = (card.network || '').toLowerCase();

  for (const rule of eligible) {
    const ruleLower = rule.toLowerCase();

    // Check for exclusion pattern: "tarjetas de cr√©dito BankX (excepto ...)"
    const exceptMatch = ruleLower.match(/\(excepto\s+(.+?)\)/);
    if (exceptMatch) {
      // This is a broad eligibility with exclusions
      const exclusions = exceptMatch[1].split(/,\s*|\s+y\s+/).map(e => e.trim().toLowerCase());

      // Check if this card is excluded
      const isExcluded = exclusions.some(excl => {
        if (!excl) return false;
        // Match against card name
        if (cardName.includes(excl)) return true;
        // Match exclusion keywords against card name parts
        // e.g., "supercashback" matches "Supercashback Banesco"
        // e.g., "business" matches "Business Banesco"
        // e.g., "visa connectmiles" matches "Visa ConnectMiles Banesco"
        const exclWords = excl.split(/\s+/);
        return exclWords.every(w => cardName.includes(w));
      });

      if (isExcluded) return false;

      // Not excluded ‚Äî check if the broad rule applies to this card
      // The text before "(excepto" describes who IS eligible
      const beforeExcept = ruleLower.split('(excepto')[0].trim();
      if (broadRuleMatchesCard(beforeExcept, card)) return true;

    } else {
      // No exclusion ‚Äî check if rule matches this card directly
      if (specificRuleMatchesCard(ruleLower, card)) return true;
    }
  }

  return false;
}

// Match a broad rule like "tarjetas de cr√©dito banesco" or "todas las tarjetas..."
function broadRuleMatchesCard(rule, card) {
  const cardName = (card.name || '').toLowerCase();
  const cardNetwork = (card.network || '').toLowerCase();
  const cardType = (card.type || card.tipo || '').toLowerCase();

  // "todas las tarjetas de cr√©dito" / "tarjetas de cr√©dito [bank]"
  if (rule.includes('todas las tarjetas') || rule.includes('tarjetas de cr√©dito') || rule.includes('tarjetas de d√©bito')) {
    if (rule.includes('cr√©dito') && cardType === 'cr√©dito') return true;
    if (rule.includes('d√©bito') && cardType === 'd√©bito') return true;
    if (!rule.includes('cr√©dito') && !rule.includes('d√©bito')) return true;
  }

  // Network-based: "mastercard", "visa", "american express"
  if (rule.includes('mastercard') && cardNetwork.includes('mastercard')) return true;
  if (rule.includes('visa') && cardNetwork.includes('visa')) return true;
  if ((rule.includes('american express') || rule.includes('amex')) &&
      (cardNetwork.includes('american') || cardNetwork.includes('amex'))) return true;

  return false;
}

// Match a specific rule like "Visa Infinite Banco Santa Cruz" or just "Mastercard"
function specificRuleMatchesCard(rule, card) {
  const cardName = (card.name || '').toLowerCase();
  const cardNetwork = (card.network || '').toLowerCase();
  const cardType = (card.type || card.tipo || '').toLowerCase();

  // Direct name match (card name contains the rule or rule contains the card name)
  if (cardName.includes(rule) || rule.includes(cardName)) return true;

  // Fuzzy: check if all significant words from the rule appear in the card name
  const ruleWords = rule.replace(/tarjetas?\s*(de\s+)?/g, '').split(/\s+/).filter(w => w.length > 2);
  if (ruleWords.length >= 2 && ruleWords.every(w => cardName.includes(w))) return true;

  // Network-only match: rule is just a network name
  const networkNames = ['visa', 'mastercard', 'american express', 'amex'];
  const ruleClean = rule.trim();
  if (networkNames.includes(ruleClean)) {
    if (ruleClean === 'visa' && cardNetwork.includes('visa')) return true;
    if (ruleClean === 'mastercard' && cardNetwork.includes('mastercard')) return true;
    if ((ruleClean === 'american express' || ruleClean === 'amex') &&
        (cardNetwork.includes('american') || cardNetwork.includes('amex'))) return true;
  }

  // "Tarjeta de D√©bito [Bank]" / "Tarjeta de Cr√©dito [Bank]"
  if (rule.includes('tarjeta de d√©bito') && cardType === 'd√©bito') return true;
  if (rule.includes('tarjeta de cr√©dito') && cardType === 'cr√©dito') return true;
  if (rule.includes('credim√°s') && cardName.includes('credim√°s')) return true;
  if (rule.includes('ultracr√©dito') && cardName.includes('ultracr√©dito')) return true;

  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCards() {
  const list = document.getElementById('cardsList');

  if (allPromos.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="big">üè¶</div><div>No hay promociones. El servidor est√° procesando...</div></div>`;
    return;
  }

  try {

  // Hidden filter shows only hidden promos
  if (activeBank === 'hidden') {
    let filtered = allPromos.filter(p => hiddenIds.has(p.id));
    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">üôà</div><div>No hay promos ocultas</div></div>`;
      return;
    }
    list.innerHTML = filtered.map((p, i) => {
      const color = banks.find(b => b.id === p.bankId)?.color || '#888';
      return `<div class="promo-card" style="animation-delay:${i*0.05}s; opacity:0.7">
        <div class="card-top">
          <div class="bank-tag"><div class="bank-dot" style="background:${color}"></div>${p.bank}</div>
          <button class="card-fav-btn" onclick="unhidePromo('${p.id}')" title="Mostrar">üëÅÔ∏è</button>
        </div>
        <div class="card-title">${p.title || 'Promoci√≥n'}</div>
      </div>`;
    }).join('');
    return;
  }

  // For all other views, exclude hidden promos
  let filtered = allPromos.filter(p => (p.isActive || p.isUpcoming) && !hiddenIds.has(p.id));

  // Filtrar por "Favoritos"
  if (activeBank === 'favoritos') {
    filtered = filtered.filter(p => favoriteIds.has(p.id));
    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">‚ù§Ô∏è</div><div>No tienes promos favoritas a√∫n. Toca el coraz√≥n en cualquier promo para agregarla.</div></div>`;
      return;
    }
  }

  // Filtrar por "Mis Productos" ‚Äî promos matching wallet cards
  if (activeBank === 'mis-productos') {
    if (walletCards.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">üí≥</div><div>Agrega tus tarjetas en el panel de la derecha para ver tus promos personalizadas</div></div>`;
      return;
    }
    filtered = filtered.filter(p => isPromoEligibleForWallet(p));
    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">üîç</div><div>No hay promos activas para tus tarjetas en este momento</div></div>`;
      return;
    }
  }

  // Filtrar por categor√≠a
  if (activeCategory !== 'all') {
    const tags = CATEGORY_TAGS[activeCategory] || [activeCategory];
    filtered = filtered.filter(p => p.categories?.some(c => tags.includes(c)));
  }

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="big">üîç</div><div>No hay promos en esta categor√≠a</div></div>`;
    return;
  }

  // ‚îÄ‚îÄ Sort ‚îÄ‚îÄ
  sortPromos(filtered);

  const rendered = filtered.map((p, i) => {
    const color = banks.find(b => b.id === p.bankId)?.color || '#888';
    const tags = [...(p.categories || []), ...(p.cardTypes || [])];

    let daysBadge = '';
    if (p.isActive) {
      const d = p.daysUntilExpiry;
      daysBadge = `<span class="days-badge active">${d != null ? (d === 0 ? 'Hoy termina' : `${d} d√≠as restantes`) : 'Vigente'}</span>`;
    } else if (p.isUpcoming) {
      daysBadge = `<span class="days-badge soon">Empieza en ${p.daysUntilStart} d√≠a${p.daysUntilStart !== 1 ? 's' : ''}</span>`;
    } else {
      daysBadge = `<span class="days-badge expired">Expirada</span>`;
    }

    const tagsHtml = tags.slice(0, 5).map(t => `<span class="tag ${t}">${t}</span>`).join('');
    const establishments = Array.isArray(p.establishments)
      ? p.establishments.slice(0, 5).join(', ')
      : p.establishments || '';

    const dateStr = p.validFrom ? `${fmt(p.validFrom)} ‚Üí ${fmt(p.validUntil)}` : '';

    const isFav = favoriteIds.has(p.id);
    const heartSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="${isFav ? '#e11d48' : 'none'}" stroke="${isFav ? '#e11d48' : '#9ca3af'}" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
    const favClass = isFav ? 'faved' : '';

    return `<div class="card-swipe-wrap" data-promo-id="${p.id}">
      <div class="swipe-bg">Ocultar</div>
      <div class="promo-card" onclick="toggleCard(this, event)" style="animation-delay:${i*0.05}s; --bcolor:${color}">
      <style>.card-swipe-wrap:nth-child(${i+1}) .promo-card::before { background: linear-gradient(90deg, ${color}, ${color}88); }</style>
      <div class="card-top">
        <div class="bank-tag">
          <div class="bank-dot" style="background:${color}"></div>
          ${p.bank}
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="pct-badge">${normalizePercentage(p)}<small>${p.promoType || ''}</small></div>
        </div>
      </div>
      <div class="card-title">${p.title || 'Promoci√≥n'}</div>
      ${tags.length ? `<div class="tags-row">${tagsHtml}</div>` : ''}
      <div class="card-desc">${p.description || ''}</div>
      <div class="card-meta">
        ${p.minimumSpend ? `<div class="meta-chip"><span>ü™ô M√≠nimo</span><span class="val">${p.minimumSpend}</span></div>` : ''}
        ${p.maxReturn ? `<div class="meta-chip hl"><span>üéØ Tope</span><span class="val">${p.maxReturn}</span></div>` : ''}
        ${p.validFrom ? `<div class="meta-chip"><span>üìÖ</span><span class="val">${dateStr}</span></div>` : ''}
        ${p.creditingDate ? `<div class="meta-chip"><span>üí∞</span><span class="val">${p.creditingDate}</span></div>` : ''}
        ${establishments ? `<div class="meta-chip" style="flex:1"><span>üè™</span><span class="val">${establishments}</span></div>` : ''}
      </div>
      ${p.notes ? `<div class="card-notes-wrap"><div class="card-desc" style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">‚ÑπÔ∏è ${p.notes}</div></div>` : ''}
      <div class="card-bottom">
        <div class="validity">
          ${daysBadge}
          ${dateStr ? `<span style="margin-left:6px;font-size:0.68rem;color:var(--muted)">${dateStr}</span>` : ''}
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="card-fav-btn ${favClass}" onclick="toggleFavorite('${p.id}', event)">${heartSvg}</button>
          <span class="card-expand-hint">Ver m√°s ‚ñæ</span>
        </div>
        <a class="card-link" href="${p.sourceUrl || '#'}" target="_blank" onclick="event.stopPropagation()">Ver T&C ‚Üó</a>
      </div>
    </div>
    </div>`;
  });

  // Inject in-feed ad every 6 cards
  const AD_EVERY = 6;
  const adUnit = `<div class="ad-card">
    <!-- AdSense in-feed: replace with your code -->
    <div class="ad-placeholder"><div class="ad-placeholder-line"></div><span>Ad</span><div class="ad-placeholder-line"></div></div>
  </div>`;
  const finalParts = [];
  rendered.forEach((card, idx) => {
    finalParts.push(card);
    if ((idx + 1) % AD_EVERY === 0 && idx < rendered.length - 1) {
      finalParts.push(adUnit);
    }
  });

  list.innerHTML = finalParts.join('');

  // Initialize swipe-to-hide on each card
  list.querySelectorAll('.card-swipe-wrap').forEach(el => {
    const promoId = el.dataset.promoId;
    if (promoId) initSwipe(el, promoId);
  });

  } catch (err) {
    console.error('renderCards error:', err);
    list.innerHTML = `<div class="empty-state"><div class="big">‚ö†Ô∏è</div><div>Error al renderizar: ${err.message}</div></div>`;
  }
}

// Extract a clean percentage from the percentage field or description
function normalizePercentage(promo) {
  const pct = promo.percentage || '';
  // If it already looks like a percentage, return it
  if (/^\d+(\.\d+)?%$/.test(pct.trim())) return pct.trim();
  // Try to extract percentage from the percentage field
  const pctMatch = pct.match(/(\d+(?:\.\d+)?)\s*%/);
  if (pctMatch) return pctMatch[1] + '%';
  // If percentage field has no %, search description for cashback/descuento percentages
  const desc = promo.description || '';
  const descMatches = desc.match(/(\d+(?:\.\d+)?)\s*%\s*(?:de\s+)?(cashback|devoluci√≥n|descuento)/gi);
  if (descMatches) {
    // Get the highest percentage mentioned with cashback/descuento
    let best = 0;
    descMatches.forEach(m => {
      const n = parseFloat(m.match(/(\d+(?:\.\d+)?)/)[1]);
      if (n > best) best = n;
    });
    if (best > 0) return best + '%';
  }
  // Last resort: any percentage in description
  const anyPct = desc.match(/(\d+(?:\.\d+)?)\s*%/);
  if (anyPct) return anyPct[1] + '%';
  return pct || '‚Äî';
}

function fmt(s) {
  if (!s) return '';
  const [y,m,d] = s.split('-');
  const months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
  return `${parseInt(d)} ${months[parseInt(m)-1]}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSort(val) {
  activeSort = val;
  if (val === 'cercania') {
    requestUserLocation(() => renderCards());
  } else {
    renderCards();
  }
}

function sortPromos(arr) {
  switch (activeSort) {
    case 'vigencia':
      arr.sort((a, b) => {
        // Active first (by daysUntilExpiry ascending), then upcoming (by daysUntilStart ascending)
        const aExp = a.isActive ? (a.daysUntilExpiry ?? 9999) : (a.isUpcoming ? 10000 + (a.daysUntilStart ?? 0) : 99999);
        const bExp = b.isActive ? (b.daysUntilExpiry ?? 9999) : (b.isUpcoming ? 10000 + (b.daysUntilStart ?? 0) : 99999);
        return aExp - bExp;
      });
      break;
    case 'cercania':
      if (userLat != null && userLng != null) {
        arr.sort((a, b) => {
          const distA = promoDistance(a);
          const distB = promoDistance(b);
          return distA - distB;
        });
      }
      break;
    case 'az':
      arr.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'es'));
      break;
    case 'za':
      arr.sort((a, b) => (b.title || '').localeCompare(a.title || '', 'es'));
      break;
  }
}

function requestUserLocation(callback) {
  if (userLat != null && userLng != null) { callback(); return; }
  if (!navigator.geolocation) {
    alert('Tu navegador no soporta geolocalizaci√≥n');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      callback();
    },
    err => {
      console.warn('Geolocation error:', err);
      alert('No se pudo obtener tu ubicaci√≥n. Verifica los permisos.');
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

// Haversine distance in km
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// Known establishment coordinates in DR
// Each key is lowercase for matching against promo establishment names
const PLACE_COORDS = {
  // ‚îÄ‚îÄ Malls & Shopping Centers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'bluemall': { lat: 18.4655, lng: -69.9295, name: 'BlueMall Santo Domingo' },
  'blue mall': { lat: 18.4655, lng: -69.9295, name: 'BlueMall Santo Domingo' },
  'agora mall': { lat: 18.4830, lng: -69.9390, name: '√Ågora Mall' },
  '√°gora mall': { lat: 18.4830, lng: -69.9390, name: '√Ågora Mall' },
  'sambil': { lat: 18.4725, lng: -69.9490, name: 'Sambil Santo Domingo' },
  'galer√≠a 360': { lat: 18.4770, lng: -69.9330, name: 'Galer√≠a 360' },
  'galeria 360': { lat: 18.4770, lng: -69.9330, name: 'Galer√≠a 360' },
  'downtown center': { lat: 18.4750, lng: -69.9100, name: 'Downtown Center' },
  'megacentro': { lat: 18.4500, lng: -69.9680, name: 'Megacentro' },
  'bella vista mall': { lat: 18.4600, lng: -69.9380, name: 'Bella Vista Mall' },

  // ‚îÄ‚îÄ Supermercados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'supermercados nacional': { lat: 18.4860, lng: -69.9310, name: 'Nacional (Lope de Vega)' },
  'nacional': { lat: 18.4860, lng: -69.9310, name: 'Nacional (Lope de Vega)' },
  'jumbo': { lat: 18.4750, lng: -69.9350, name: 'Jumbo (Churchill)' },
  'la sirena': { lat: 18.4710, lng: -69.9320, name: 'La Sirena (27 de Febrero)' },
  'sirena': { lat: 18.4710, lng: -69.9320, name: 'La Sirena (27 de Febrero)' },
  'bravo': { lat: 18.4700, lng: -69.9400, name: 'Bravo (Naco)' },
  'hipermercados ol√©': { lat: 18.4610, lng: -69.9280, name: 'Ol√© (SD)' },
  'ol√©': { lat: 18.4610, lng: -69.9280, name: 'Ol√© (SD)' },
  'bebemundo': { lat: 18.4760, lng: -69.9330, name: 'Bebemundo' },

  // ‚îÄ‚îÄ Plaza Lama locations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'plaza lama': { lat: 18.4720, lng: -69.9130, name: 'Plaza Lama (Duarte)' },
  'plaza lama - duarte': { lat: 18.4720, lng: -69.9130, name: 'Plaza Lama Duarte' },
  'plaza lama - ferias': { lat: 18.4810, lng: -69.9520, name: 'Plaza Lama Ferias' },
  'plaza lama - 27 de febrero': { lat: 18.4810, lng: -69.9520, name: 'Plaza Lama 27 Feb' },
  'plaza lama - herrera': { lat: 18.4885, lng: -69.9700, name: 'Plaza Lama Herrera' },
  'plaza lama - santiago': { lat: 19.4500, lng: -70.6870, name: 'Plaza Lama Santiago' },
  'plaza lama - zona oriental': { lat: 18.5010, lng: -69.8570, name: 'Plaza Lama Zona Oriental' },
  'plaza lama - b√°varo': { lat: 18.6820, lng: -68.4050, name: 'Plaza Lama B√°varo' },
  'plaza lama - hig√ºey': { lat: 18.6150, lng: -68.7080, name: 'Plaza Lama Hig√ºey' },

  // ‚îÄ‚îÄ Tiendas / Retail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'casa cuesta': { lat: 18.4870, lng: -69.9385, name: 'Casa Cuesta' },
  'corripio': { lat: 18.4740, lng: -69.9020, name: 'Corripio (Zona Colonial)' },
  'tiendas corripio': { lat: 18.4740, lng: -69.9020, name: 'Corripio' },
  'distribuidora corripio': { lat: 18.4740, lng: -69.9020, name: 'Corripio' },
  'tiendas el encanto': { lat: 18.4720, lng: -69.9380, name: 'El Encanto' },
  'el encanto': { lat: 18.4720, lng: -69.9380, name: 'El Encanto' },
  'el mundo del juguete': { lat: 18.4760, lng: -69.9330, name: 'El Mundo del Juguete' },
  'carol': { lat: 18.4850, lng: -69.9380, name: 'Carol' },
  'jenny polanco': { lat: 18.4655, lng: -69.9295, name: 'Jenny Polanco (BlueMall)' },
  'tous': { lat: 18.4655, lng: -69.9295, name: 'TOUS (BlueMall)' },
  'lacoste': { lat: 18.4655, lng: -69.9295, name: 'Lacoste (BlueMall)' },
  'cartier': { lat: 18.4655, lng: -69.9295, name: 'Cartier (BlueMall)' },
  'montblanc': { lat: 18.4655, lng: -69.9295, name: 'Montblanc (BlueMall)' },
  'rolex': { lat: 18.4655, lng: -69.9295, name: 'Rolex (BlueMall)' },
  'tudor': { lat: 18.4655, lng: -69.9295, name: 'Tudor (BlueMall)' },
  'bath and body works': { lat: 18.4830, lng: -69.9390, name: 'Bath & Body Works (√Ågora)' },
  'sleep center': { lat: 18.4770, lng: -69.9330, name: 'Sleep Center' },
  'conformatic': { lat: 18.4740, lng: -69.9350, name: 'Conformatic' },
  'ilumel': { lat: 18.4790, lng: -69.9310, name: 'Ilumel' },
  'lolita home': { lat: 18.4720, lng: -69.9380, name: 'Lolita Home' },
  'hair plus': { lat: 18.4760, lng: -69.9330, name: 'Hair Plus' },

  // ‚îÄ‚îÄ Restaurantes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'la cassina': { lat: 18.4660, lng: -69.9290, name: 'La Cassina' },
  'la bistecca': { lat: 18.4665, lng: -69.9285, name: 'La Bistecca (BlueMall)' },
  'peperoni': { lat: 18.4830, lng: -69.9395, name: 'Peperoni (√Ågora)' },
  'il bacareto': { lat: 18.4735, lng: -69.9350, name: 'Il Bacareto' },
  'cappuccino': { lat: 18.4850, lng: -69.9340, name: 'Cappuccino' },
  'habanero': { lat: 18.4850, lng: -69.9360, name: 'Habanero' },
  'casa brava': { lat: 18.4840, lng: -69.9380, name: 'Casa Brava' },
  'el catador': { lat: 18.4830, lng: -69.9350, name: 'El Catador' },
  'catador': { lat: 18.4830, lng: -69.9350, name: 'El Catador' },
  'maialino': { lat: 18.4840, lng: -69.9340, name: 'Maialino' },
  'mamma luisa': { lat: 18.4825, lng: -69.9360, name: 'Mamma Luisa' },
  'la scarpetta': { lat: 18.4840, lng: -69.9350, name: 'La Scarpetta' },
  'pascale': { lat: 18.4835, lng: -69.9345, name: 'Pascale' },
  'donoma': { lat: 18.4850, lng: -69.9335, name: 'Donoma' },
  'sapori': { lat: 18.4830, lng: -69.9370, name: "Sapori D'Italia" },
  'caf√© locanda': { lat: 18.4735, lng: -69.8930, name: 'Caf√© Locanda (Zona Colonial)' },
  'restaurante don pepe': { lat: 18.4850, lng: -69.9310, name: 'Don Pepe' },
  'restaurante ona': { lat: 18.4660, lng: -69.9290, name: 'Ona (BlueMall)' },
  'casa menc√≠a': { lat: 18.4835, lng: -69.9340, name: 'Casa Menc√≠a' },
  'restor√°n gazpacho': { lat: 18.4830, lng: -69.9345, name: 'Gazpacho' },
  'las arabitas': { lat: 18.4845, lng: -69.9360, name: 'Las Arabitas' },
  'la bodega': { lat: 18.4840, lng: -69.9345, name: 'La Bodega' },
  'la parrillita': { lat: 19.4510, lng: -70.6880, name: 'La Parrillita (Santiago)' },
  'rancho chito': { lat: 19.4500, lng: -70.6860, name: 'Rancho Chito (Santiago)' },
  'casa luca': { lat: 18.4855, lng: -69.9345, name: 'Casa Luca' },
  'lila': { lat: 18.4840, lng: -69.9350, name: 'Lila' },
  'laurel': { lat: 18.4845, lng: -69.9340, name: 'Laurel' },
  'el atelier': { lat: 18.4835, lng: -69.9355, name: 'El Atelier' },

  // ‚îÄ‚îÄ Hoteles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'hilton': { lat: 18.4720, lng: -69.8940, name: 'Hilton Santo Domingo' },
  'hyatt': { lat: 18.6900, lng: -68.4060, name: 'Hyatt (Cap Cana)' },
  'marriott': { lat: 18.4810, lng: -69.9430, name: 'JW Marriott Santo Domingo' },
  'sheraton': { lat: 18.4710, lng: -69.9360, name: 'Sheraton Santo Domingo' },
  'intercontinental': { lat: 18.4720, lng: -69.9340, name: 'InterContinental SD' },
  'w hotel': { lat: 18.4660, lng: -69.9295, name: 'W Santo Domingo' },
  'embassy suites': { lat: 18.4750, lng: -69.9380, name: 'Embassy Suites SD' },
  'four points': { lat: 18.4730, lng: -69.9370, name: 'Four Points SD' },
  'aloft': { lat: 18.4735, lng: -69.9360, name: 'Aloft Santo Domingo' },
  'jaragua': { lat: 18.4630, lng: -69.9320, name: 'Hotel Jaragua' },
  'dreams': { lat: 18.7200, lng: -68.3980, name: 'Dreams Punta Cana' },
  'secrets': { lat: 18.7180, lng: -68.4000, name: 'Secrets Cap Cana' },
  'casa del xvi': { lat: 18.4730, lng: -69.8860, name: 'Casa del XVI (Zona Colonial)' },
  'days inn': { lat: 18.4210, lng: -69.6040, name: 'Days Inn Juan Dolio' },

  // ‚îÄ‚îÄ Deportes / Gym ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'sportcity': { lat: 18.4690, lng: -69.9280, name: 'SportCity' },
  'aqua live': { lat: 18.4700, lng: -69.9300, name: 'Aqua Live' },
  'aro & pedal': { lat: 18.4760, lng: -69.9340, name: 'Aro & Pedal' },

  // ‚îÄ‚îÄ Transporte / Aerol√≠neas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'arajet': { lat: 18.4296, lng: -69.6688, name: 'Aeropuerto Las Am√©ricas' },
  'aeropuerto': { lat: 18.4296, lng: -69.6688, name: 'Aeropuerto Las Am√©ricas' },

  // ‚îÄ‚îÄ Farmacias ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'farmacia value': { lat: 18.4790, lng: -69.9310, name: 'Farmacia Value' },

  // ‚îÄ‚îÄ Santiago locations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'santiago country club': { lat: 19.4600, lng: -70.6830, name: 'Santiago Country Club' },
  'centro espa√±ol': { lat: 19.4420, lng: -70.6850, name: 'Centro Espa√±ol (Santiago)' },

  // ‚îÄ‚îÄ Otros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'elevapos': { lat: 18.4760, lng: -69.9330, name: 'Elevapos' },
  'innova centro': { lat: 18.4810, lng: -69.9300, name: 'Innova Centro' },
  'grupo bentrani': { lat: 18.4740, lng: -69.9350, name: 'Grupo Bentrani' },
  'cos fi clinic': { lat: 18.4780, lng: -69.9340, name: 'Cos Fi Clinic' },
  'carnaval de punta cana': { lat: 18.5820, lng: -68.4050, name: 'Carnaval de Punta Cana' },
  'valle nevado': { lat: 19.2700, lng: -70.4200, name: 'Valle Nevado (Constanza)' },
};

function promoDistance(promo) {
  if (userLat == null || userLng == null) return 99999;
  const ests = Array.isArray(promo.establishments) ? promo.establishments : [];
  const title = (promo.title || '').toLowerCase();
  const desc = (promo.description || '').toLowerCase();
  const allText = [...ests.map(e => e.toLowerCase()), title, desc];

  let minDist = 99999;
  for (const text of allText) {
    for (const [key, coord] of Object.entries(PLACE_COORDS)) {
      if (text.includes(key)) {
        const d = haversine(userLat, userLng, coord.lat, coord.lng);
        if (d < minDist) minDist = d;
      }
    }
  }
  return minDist;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BANK FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBankFilter(banks) {
  const filter = document.getElementById('bankFilter');
  // Keep the static Todos + Mis Productos buttons, only replace the bank buttons after them
  const bankBtns = banks.filter(b => b.promoCount > 0).map(b =>
    `<button class="bank-btn" data-bank="${b.id}" onclick="setBank('${b.id}',this)"
      style="--bc:${b.color}">${b.name}</button>`
  ).join('');
  filter.innerHTML =
    `<button class="bank-btn mis-bank-btn" data-bank="mis-productos" onclick="setBank('mis-productos',this)">‚≠ê Mis Productos</button>` +
    `<button class="bank-btn fav-bank-btn" data-bank="favoritos" onclick="setBank('favoritos',this)">‚ù§Ô∏è Favoritos</button>` +
    `<button class="bank-btn active-all" data-bank="all" onclick="setBank('all',this)">Todos</button>` +
    `<button class="bank-btn hidden-bank-btn" data-bank="hidden" onclick="setBank('hidden',this)">üôà Hidden</button>` +
    bankBtns;
}

function setCategory(cat, el) {
  activeCategory = cat;
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderCards();
}

function setBank(bank, el) {
  activeBank = bank;
  document.querySelectorAll('.bank-btn').forEach(b => {
    b.classList.remove('active-all');
    b.style.background = '';
    b.style.borderColor = '';
    b.style.color = '';
  });
  el.classList.add('active-all');
  if (bank === 'mis-productos') {
    el.style.background = 'var(--accent2)';
    el.style.borderColor = 'var(--accent2)';
    el.style.color = '#fff';
  } else if (bank === 'favoritos') {
    el.style.background = '#e11d48';
    el.style.borderColor = '#e11d48';
    el.style.color = '#fff';
  } else if (bank === 'hidden') {
    el.style.background = 'var(--muted)';
    el.style.borderColor = 'var(--muted)';
    el.style.color = '#fff';
  } else if (bank !== 'all') {
    const bc = banks.find(b => b.id === bank)?.color || '';
    el.style.background = bc;
    el.style.borderColor = bc;
    el.style.color = '#000';
  }
  // Favoritos and Hidden don't need API reload, just re-render
  if (bank === 'favoritos' || bank === 'hidden') {
    renderCards();
  } else {
    loadData();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WALLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getNetworkClass(network) {
  if (!network) return '';
  const n = network.toLowerCase();
  if (n.includes('visa')) return 'visa';
  if (n.includes('mastercard')) return 'mastercard';
  if (n.includes('american') || n.includes('amex')) return 'amex';
  return '';
}

function getNetworkLabel(network) {
  if (!network) return '';
  const n = network.toLowerCase();
  if (n.includes('visa')) return 'Visa';
  if (n.includes('mastercard')) return 'MC';
  if (n.includes('american') || n.includes('amex')) return 'Amex';
  return network;
}

async function renderWallet() {
  const wl = document.getElementById('walletList');
  if (walletCards.length === 0) {
    wl.innerHTML = '<div style="font-size:0.8rem;color:var(--muted);padding:8px 0 12px">Agrega tus tarjetas para ver promos personalizadas</div>';
    return;
  }

  let matches = [];
  try { matches = await matchWallet(); } catch {}

  wl.innerHTML = walletCards.map((c, i) => {
    const match = matches[i];
    const count = match?.promoCount || 0;
    // Support both new format (bankId) and old format (bank)
    const bankId = c.bankId || '';
    const bankColor = (bankId && cardCatalog[bankId]?.color) ||
                      banks.find(b => b.name === c.bank || b.id === bankId)?.color || '#555';
    const cardType = c.type || c.tipo || '';
    const network = c.network || '';
    const netClass = getNetworkClass(network);
    const netLabel = getNetworkLabel(network);
    const typeClass = cardType === 'cr√©dito' ? 'credito' : 'debito';

    return `<div class="card-item">
      <div class="card-dot" style="background:${bankColor}"></div>
      <div class="card-info">
        <div class="card-name">${c.name}</div>
        <div class="card-badges">
          ${netLabel ? `<span class="net-badge ${netClass}">${netLabel}</span>` : ''}
          ${cardType ? `<span class="type-badge ${typeClass}">${cardType}</span>` : ''}
        </div>
      </div>
      <div class="card-promos ${count === 0 ? 'zero' : ''}">${count}</div>
      <button class="card-del" onclick="removeCard(${i})" title="Eliminar">‚úï</button>
    </div>`;
  }).join('');
}

function removeCard(i) {
  walletCards.splice(i, 1);
  saveState('cashbackdo_wallet', walletCards);
  renderWallet();
  if (activeBank === 'mis-productos') renderCards();
}

function addCard() {
  const bankId = document.getElementById('cardBank').value;
  const cardSel = document.getElementById('cardName');
  const cardId = cardSel.value;
  if (!bankId || !cardId) return;

  const selectedOpt = cardSel.options[cardSel.selectedIndex];
  const network = selectedOpt.dataset.network || '';
  const type = selectedOpt.dataset.type || '';
  const name = selectedOpt.text;
  const bankName = cardCatalog[bankId]?.name || bankId;

  // Avoid duplicates
  if (walletCards.some(c => c.cardId === cardId)) return;

  walletCards.push({ bankId, cardId, name, bank: bankName, network, type });
  saveState('cashbackdo_wallet', walletCards);

  document.getElementById('cardBank').value = '';
  document.getElementById('cardName').innerHTML = '<option value="">Selecciona banco primero</option>';
  document.getElementById('cardName').disabled = true;
  renderWallet();
  if (activeBank === 'mis-productos') renderCards();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPLE WALLET MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openWalletModal() {
  modalSelected.clear();
  document.getElementById('modalSearch').value = '';
  renderModalList('');
  document.getElementById('walletModal').classList.add('open');
  document.getElementById('modalSearch').focus();
}

function closeWalletModal() {
  document.getElementById('walletModal').classList.remove('open');
}

function closeWalletModalOutside(e) {
  if (e.target === document.getElementById('walletModal')) closeWalletModal();
}

function renderModalList(query) {
  const list = document.getElementById('modalList');
  const q = query.toLowerCase().trim();
  let html = '';

  Object.entries(cardCatalog).forEach(([bankId, bank]) => {
    const filtered = bank.cards.filter(c =>
      !q || c.name.toLowerCase().includes(q) || bank.name.toLowerCase().includes(q)
    );
    if (!filtered.length) return;

    html += `<div class="modal-bank-header" style="color:${bank.color}">${bank.name}</div>`;
    filtered.forEach(c => {
      const checked = modalSelected.has(c.id) ? 'checked' : '';
      const netClass = getNetworkClass(c.network);
      const netLabel = getNetworkLabel(c.network);
      const typeClass = c.type === 'cr√©dito' ? 'credito' : 'debito';
      html += `<label class="modal-item">
        <input type="checkbox" ${checked} onchange="toggleModalCard('${bankId}','${c.id}')" />
        <div class="modal-item-dot" style="background:${bank.color}"></div>
        <span class="modal-item-name">${c.name}</span>
        <div class="modal-item-badges">
          ${netLabel ? `<span class="net-badge ${netClass}">${netLabel}</span>` : ''}
          <span class="type-badge ${typeClass}">${c.type}</span>
        </div>
      </label>`;
    });
  });

  list.innerHTML = html || '<div style="padding:20px;text-align:center;color:var(--muted)">Sin resultados</div>';
  updateModalCount();
}

function filterModalCards() {
  renderModalList(document.getElementById('modalSearch').value);
}

function toggleModalCard(bankId, cardId) {
  if (modalSelected.has(cardId)) {
    modalSelected.delete(cardId);
  } else {
    modalSelected.add(cardId);
  }
  updateModalCount();
}

function updateModalCount() {
  const n = modalSelected.size;
  document.getElementById('modalCount').textContent = `${n} tarjeta${n !== 1 ? 's' : ''} seleccionada${n !== 1 ? 's' : ''}`;
  document.getElementById('modalAddBtn').disabled = n === 0;
}

function addModalSelected() {
  let added = 0;
  Object.entries(cardCatalog).forEach(([bankId, bank]) => {
    bank.cards.forEach(c => {
      if (!modalSelected.has(c.id)) return;
      if (walletCards.some(w => w.cardId === c.id)) return; // skip duplicates
      walletCards.push({ bankId, cardId: c.id, name: c.name, bank: bank.name, network: c.network, type: c.type });
      added++;
    });
  });

  saveState('cashbackdo_wallet', walletCards);
  closeWalletModal();
  if (added > 0) {
    renderWallet();
    if (activeBank === 'mis-productos') renderCards();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCRAPE STATS ‚Üí Simple timestamp
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderScrapeStats(stats) {
  const el = document.getElementById('settingsLastUpdate');
  if (!el) return;
  if (!stats.lastUpdated) { el.textContent = '√öltima actualizaci√≥n: ‚Äî'; return; }
  const d = new Date(stats.lastUpdated);
  el.textContent = `√öltima actualizaci√≥n: ${d.toLocaleDateString('es-DO', { day:'numeric', month:'short', year:'numeric' })} ${d.toLocaleTimeString('es-DO', { hour:'2-digit', minute:'2-digit' })}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRIGGER MANUAL SCRAPE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function triggerScrape() {
  const key = prompt('Ingresa tu ADMIN_API_KEY del servidor:') || ADMIN_KEY;
  if (!key) return;
  localStorage.setItem('cashbackdo_adminkey', key);

  const btn = document.getElementById('scrapeBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  try {
    const res = await fetch(`${API_BASE}/api/scrape`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': key },
      body: JSON.stringify({})
    });
    if (!res.ok) throw new Error('No autorizado');
    showToast('Sistema', 'üîÑ Scraping iniciado en el servidor', 'Los datos se actualizar√°n en unos minutos. Recarga la p√°gina cuando termine.');
    // Poll cada 30s para detectar cuando termina (max 10 min)
    let pollCount = 0;
    const poll = setInterval(async () => {
      pollCount++;
      if (pollCount > 20) { clearInterval(poll); btn.classList.remove('loading'); btn.disabled = false; return; }
      try {
        const s = await fetchStats();
        if (s.lastUpdated && Date.now() - new Date(s.lastUpdated) < 120000) {
          clearInterval(poll);
          loadData();
          btn.classList.remove('loading');
          btn.disabled = false;
        }
      } catch {}
    }, 30000);
  } catch (err) {
    alert('Error: ' + err.message);
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Real Geolocation State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let geoWatchId = null;         // navigator.geolocation watchPosition ID
let geoCheckInterval = null;   // 30s proximity check loop
let dwellPlace = null;         // current place user is dwelling at { key, name, lat, lng }
let dwellStart = null;         // timestamp when dwell started
let dwellTimerRef = null;      // interval for the UI timer
let dwellNotified = false;     // already fired notification for this dwell?
const DWELL_RADIUS_KM = 0.2;  // 200 meters
const DWELL_TIME_SEC = 300;    // 5 minutes

// Toggle location from settings panel
function onToggleLocation(checked) {
  const statusEl = document.getElementById('locationStatus');
  const toggle = document.getElementById('toggleLocation');

  if (!checked) {
    geoActive = false;
    saveState('cashbackdo_location_enabled', false);
    if (statusEl) statusEl.style.display = 'none';
    stopGeo();
    return;
  }

  // Check permission state first (Permissions API where supported)
  if (navigator.permissions && navigator.permissions.query) {
    navigator.permissions.query({ name: 'geolocation' }).then(result => {
      if (result.state === 'denied') {
        // Permission was previously denied ‚Äî show help
        showLocationDeniedHelp(statusEl, toggle);
        return;
      }
      // 'granted' or 'prompt' ‚Äî proceed
      requestAndStartGeo(statusEl, toggle);
    }).catch(() => {
      // Permissions API not supported (iOS Safari) ‚Äî just try it
      requestAndStartGeo(statusEl, toggle);
    });
  } else {
    // No Permissions API (iOS Safari) ‚Äî just try it
    requestAndStartGeo(statusEl, toggle);
  }
}

function requestAndStartGeo(statusEl, toggle) {
  // Use getCurrentPosition first to trigger the permission prompt
  // watchPosition on iOS sometimes silently fails without a prior prompt
  if (statusEl) statusEl.style.display = 'block';
  document.getElementById('locName').textContent = 'Solicitando permiso...';
  document.getElementById('locSub').textContent = 'Acepta el permiso de ubicaci√≥n';

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      // Permission granted ‚Äî start real tracking
      geoActive = true;
      saveState('cashbackdo_location_enabled', true);
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      startGeo();
    },
    (err) => {
      console.warn('Location permission error:', err.code, err.message);
      if (err.code === 1) {
        // PERMISSION_DENIED
        showLocationDeniedHelp(statusEl, toggle);
      } else if (err.code === 2) {
        // POSITION_UNAVAILABLE
        document.getElementById('locName').textContent = 'Ubicaci√≥n no disponible';
        document.getElementById('locSub').textContent = 'Verifica que el GPS est√© activo';
        geoActive = false;
        toggle.checked = false;
        saveState('cashbackdo_location_enabled', false);
      } else {
        // TIMEOUT
        document.getElementById('locName').textContent = 'Tiempo agotado';
        document.getElementById('locSub').textContent = 'Intenta de nuevo en un √°rea con mejor se√±al';
        geoActive = false;
        toggle.checked = false;
        saveState('cashbackdo_location_enabled', false);
      }
    },
    { enableHighAccuracy: true, timeout: 15000 }
  );
}

function showLocationDeniedHelp(statusEl, toggle) {
  if (statusEl) statusEl.style.display = 'block';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const dot = document.getElementById('pulseDot');
  if (dot) { dot.style.background = 'var(--accent3)'; dot.classList.remove('active'); }

  if (isIOS) {
    document.getElementById('locName').textContent = 'Permiso denegado';
    document.getElementById('locSub').innerHTML = 'Act√≠valo en: <strong>Configuraci√≥n ‚Üí Privacidad ‚Üí Localizaci√≥n ‚Üí Safari</strong> (o el nombre de la app) ‚Üí <strong>"Mientras se usa"</strong>';
  } else {
    document.getElementById('locName').textContent = 'Permiso denegado';
    document.getElementById('locSub').textContent = 'Activa el permiso de ubicaci√≥n en la configuraci√≥n de tu navegador para este sitio.';
  }

  geoActive = false;
  toggle.checked = false;
  saveState('cashbackdo_location_enabled', false);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATION TOGGLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onToggleNotifMaster(checked) {
  const subToggles = document.getElementById('notifSubToggles');
  if (checked) {
    // Request notification permission from browser
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(perm => {
        if (perm !== 'granted') {
          document.getElementById('toggleNotifMaster').checked = false;
          saveState('cashbackdo_notif_master', false);
          subToggles.style.opacity = '0.45';
          subToggles.style.pointerEvents = 'none';
          return;
        }
        enableNotifSubToggles(subToggles);
      });
    } else if ('Notification' in window && Notification.permission === 'granted') {
      enableNotifSubToggles(subToggles);
    } else {
      // Notifications not supported
      enableNotifSubToggles(subToggles);
    }
  } else {
    subToggles.style.opacity = '0.45';
    subToggles.style.pointerEvents = 'none';
    // Turn off all sub-toggles
    ['toggleNotifNewPromos','toggleNotifNearby','toggleNotifExpiring','toggleNotifUpdated'].forEach(id => {
      document.getElementById(id).checked = false;
    });
    saveNotifPrefs();
  }
  saveState('cashbackdo_notif_master', checked);
}

function enableNotifSubToggles(subToggles) {
  subToggles.style.opacity = '1';
  subToggles.style.pointerEvents = 'auto';
  // Enable all sub-toggles by default when master is turned on for first time
  const prefs = loadState('cashbackdo_notif_prefs', null);
  if (!prefs) {
    ['toggleNotifNewPromos','toggleNotifNearby','toggleNotifExpiring','toggleNotifUpdated'].forEach(id => {
      document.getElementById(id).checked = true;
    });
    saveNotifPrefs();
  }
}

function onToggleNotifSub() {
  saveNotifPrefs();
}

function saveNotifPrefs() {
  const prefs = {
    newPromos: document.getElementById('toggleNotifNewPromos').checked,
    nearby: document.getElementById('toggleNotifNearby').checked,
    expiring: document.getElementById('toggleNotifExpiring').checked,
    updated: document.getElementById('toggleNotifUpdated').checked
  };
  saveState('cashbackdo_notif_prefs', prefs);
}

// Restore settings toggles from localStorage on page load
function restoreSettingsState() {
  // Location ‚Äî re-request permission on restore (iOS may revoke between sessions)
  const locEnabled = loadState('cashbackdo_location_enabled', false);
  const locToggle = document.getElementById('toggleLocation');
  if (locToggle && locEnabled) {
    locToggle.checked = true;
    const statusEl = document.getElementById('locationStatus');
    requestAndStartGeo(statusEl, locToggle);
  }

  // Notifications master
  const notifMaster = loadState('cashbackdo_notif_master', false);
  const masterToggle = document.getElementById('toggleNotifMaster');
  if (masterToggle && notifMaster) {
    masterToggle.checked = true;
    const subToggles = document.getElementById('notifSubToggles');
    subToggles.style.opacity = '1';
    subToggles.style.pointerEvents = 'auto';
  }

  // Notification sub-toggles
  const notifPrefs = loadState('cashbackdo_notif_prefs', null);
  if (notifPrefs) {
    if (notifPrefs.newPromos) document.getElementById('toggleNotifNewPromos').checked = true;
    if (notifPrefs.nearby) document.getElementById('toggleNotifNearby').checked = true;
    if (notifPrefs.expiring) document.getElementById('toggleNotifExpiring').checked = true;
    if (notifPrefs.updated) document.getElementById('toggleNotifUpdated').checked = true;
  }
}

function startGeo() {
  if (!navigator.geolocation) {
    document.getElementById('locName').textContent = 'Geolocalizaci√≥n no disponible';
    document.getElementById('locSub').textContent = 'Tu navegador no soporta GPS';
    return;
  }

  const dot = document.getElementById('pulseDot');
  dot.style.background = 'var(--accent4)';
  dot.classList.add('active');
  document.getElementById('locName').textContent = 'Buscando ubicaci√≥n...';
  document.getElementById('locSub').textContent = '';
  document.getElementById('timerWrap').style.display = 'none';
  document.getElementById('nearbyPromo').style.display = 'none';

  // Start watching real GPS position
  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      dot.style.background = 'var(--accent)';
      // Update sort if in cercan√≠a mode
      if (activeSort === 'cercan√≠a') renderCards();
    },
    (err) => {
      console.warn('Geo error:', err.message);
      dot.style.background = 'var(--accent3)';
      // If permission denied, show iOS-specific guidance
      if (err.code === 1) {
        const statusEl = document.getElementById('locationStatus');
        const toggle = document.getElementById('toggleLocation');
        showLocationDeniedHelp(statusEl, toggle);
      } else {
        document.getElementById('locName').textContent = 'Error de ubicaci√≥n';
        document.getElementById('locSub').textContent = 'No se pudo obtener GPS ‚Äî verifica tu se√±al';
      }
    },
    { enableHighAccuracy: true, maximumAge: 30000, timeout: 15000 }
  );

  // Start proximity check loop every 30 seconds
  checkNearbyEstablishments(); // immediate first check
  geoCheckInterval = setInterval(checkNearbyEstablishments, 30000);
}

function stopGeo() {
  // Stop GPS watch
  if (geoWatchId !== null) {
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
  }
  // Stop proximity check
  clearInterval(geoCheckInterval);
  geoCheckInterval = null;
  // Stop dwell timer
  clearInterval(dwellTimerRef);
  dwellTimerRef = null;
  dwellPlace = null;
  dwellStart = null;
  dwellNotified = false;

  // Reset UI
  const dot = document.getElementById('pulseDot');
  if (dot) {
    dot.style.background = 'var(--muted)';
    dot.classList.remove('active');
  }
  document.getElementById('locName').textContent = 'Ubicaci√≥n no activa';
  document.getElementById('locSub').textContent = 'Activa para ver promos cercanas';
  document.getElementById('timerWrap').style.display = 'none';
  document.getElementById('nearbyPromo').style.display = 'none';
}

// ‚îÄ‚îÄ Proximity Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkNearbyEstablishments() {
  if (userLat == null || userLng == null) return;

  // Find the closest known establishment within radius
  let closest = null;
  let closestDist = DWELL_RADIUS_KM;

  for (const [key, place] of Object.entries(PLACE_COORDS)) {
    const d = haversine(userLat, userLng, place.lat, place.lng);
    if (d < closestDist) {
      closestDist = d;
      closest = { key, ...place };
    }
  }

  if (closest) {
    // User is near an establishment
    if (!dwellPlace || dwellPlace.key !== closest.key) {
      // New place ‚Äî start dwell
      dwellPlace = closest;
      dwellStart = Date.now();
      dwellNotified = false;
      startDwellTimer();
    }
    // Update UI
    document.getElementById('locName').textContent = closest.name;
    document.getElementById('locSub').textContent = `A ${Math.round(closestDist * 1000)}m de ti`;
  } else {
    // Not near anything
    if (dwellPlace) {
      // Left the place
      dwellPlace = null;
      dwellStart = null;
      dwellNotified = false;
      clearInterval(dwellTimerRef);
      dwellTimerRef = null;
      document.getElementById('timerWrap').style.display = 'none';
    }
    document.getElementById('locName').textContent = 'Ubicaci√≥n activa';
    document.getElementById('locSub').textContent = `${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
    document.getElementById('nearbyPromo').style.display = 'none';
  }
}

// ‚îÄ‚îÄ Dwell Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startDwellTimer() {
  clearInterval(dwellTimerRef);
  document.getElementById('timerWrap').style.display = 'block';
  document.getElementById('nearbyPromo').style.display = 'none';

  dwellTimerRef = setInterval(() => {
    if (!dwellStart || !dwellPlace) { clearInterval(dwellTimerRef); return; }
    const elapsed = Math.floor((Date.now() - dwellStart) / 1000);
    const m = Math.floor(elapsed / 60), s = elapsed % 60;
    document.getElementById('timerLabel').textContent = `${m}:${s.toString().padStart(2,'0')} / 5:00`;
    document.getElementById('timerFill').style.width = Math.min(elapsed / DWELL_TIME_SEC * 100, 100) + '%';

    if (elapsed >= DWELL_TIME_SEC && !dwellNotified) {
      dwellNotified = true;
      triggerNearbyPromos(dwellPlace);
    }
  }, 1000);
}

// ‚îÄ‚îÄ Trigger Notification When Dwell Met ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerNearbyPromos(place) {
  // Find promos that match this establishment
  const matchingPromos = allPromos.filter(p => {
    if (!p.isActive) return false;
    const ests = (p.establishments || []).map(e => e.toLowerCase());
    const title = (p.title || '').toLowerCase();
    const desc = (p.description || '').toLowerCase();
    const allText = [...ests, title, desc];
    return allText.some(text => text.includes(place.key));
  });

  const np = document.getElementById('nearbyPromo');
  if (matchingPromos.length > 0) {
    const summaries = matchingPromos.slice(0, 3).map(p => {
      const pct = normalizePercentage(p);
      const bankName = banks.find(b => b.id === p.bankId)?.name || p.bankId;
      return `<div style="margin-bottom:4px"><strong>${bankName}</strong> ‚Äî ${pct} ${p.title}</div>`;
    }).join('');
    const moreText = matchingPromos.length > 3 ? `<div style="font-size:0.7rem;color:var(--muted)">+${matchingPromos.length - 3} promo(s) m√°s</div>` : '';

    np.style.display = 'block';
    np.innerHTML = `<div style="font-size:0.65rem;font-weight:700;background:var(--accent);color:#fff;display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:99px;margin-bottom:8px">üîî +5 min en ${place.name}</div>
      ${summaries}${moreText}`;

    // Show in-app toast
    const firstPromo = matchingPromos[0];
    const bankName = banks.find(b => b.id === firstPromo.bankId)?.name || '';
    showToast(bankName, `¬°Llevas 5+ min en ${place.name}!`, `${matchingPromos.length} promo(s) disponibles aqu√≠`);

    // Send browser notification if enabled
    sendBrowserNotification(
      `üìç ${place.name}`,
      `${matchingPromos.length} promo(s) de cashback disponibles aqu√≠`
    );
  } else {
    np.style.display = 'block';
    np.innerHTML = `<div style="font-size:0.65rem;font-weight:700;background:var(--accent4);color:#fff;display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:99px;margin-bottom:8px">üìç +5 min en ${place.name}</div>
      <div style="font-size:0.8rem;color:var(--muted)">No hay promos activas para este lugar</div>`;
  }
}

// ‚îÄ‚îÄ Browser Notification Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sendBrowserNotification(title, body) {
  const notifPrefs = loadState('cashbackdo_notif_prefs', {});
  const masterOn = loadState('cashbackdo_notif_master', false);
  if (!masterOn || !notifPrefs.nearby) return;
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body, icon: './icon.svg', tag: 'cashbackdo-nearby' });
  }
}

function showToast(bank, msg, sub) {
  document.getElementById('toastBank').textContent = bank;
  document.getElementById('toastMsg').textContent = msg;
  document.getElementById('toastSub').textContent = sub || '';
  const t = document.getElementById('notifToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 8000);
}
function closeToast() { document.getElementById('notifToast').classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAWER / SETTINGS TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleWalletDrawer() {
  const drawer = document.getElementById('walletDrawer');
  const overlay = document.getElementById('drawerOverlay');
  const isOpen = drawer.classList.contains('open');
  closeAllDrawers();
  if (!isOpen) {
    drawer.classList.add('open');
    overlay.classList.add('open');
    document.getElementById('walletBtn').classList.add('active');
  }
}

function toggleSettings() {
  const dd = document.getElementById('settingsDropdown');
  const isOpen = dd.classList.contains('open');
  closeAllDrawers();
  if (!isOpen) {
    dd.classList.add('open');
    document.getElementById('settingsBtn').classList.add('active');
    _settingsJustOpened = true;
  }
}

function closeAllDrawers() {
  document.getElementById('walletDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('settingsDropdown').classList.remove('open');
  document.getElementById('walletBtn').classList.remove('active');
  document.getElementById('settingsBtn').classList.remove('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARD EXPAND/COLLAPSE (mobile)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCard(el, event) {
  // Only on mobile
  if (window.innerWidth > 600) return;
  // Don't toggle if clicking a link or button
  if (event.target.closest('a') || event.target.closest('.card-fav-btn')) return;
  el.classList.toggle('expanded');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAVORITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFavorite(promoId, event) {
  event.stopPropagation();
  const btn = event.currentTarget;
  const emptyHeart = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
  const filledHeart = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#e11d48" stroke="#e11d48" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
  if (favoriteIds.has(promoId)) {
    favoriteIds.delete(promoId);
    btn.innerHTML = emptyHeart;
    btn.classList.remove('faved');
  } else {
    favoriteIds.add(promoId);
    btn.innerHTML = filledHeart;
    btn.classList.add('faved');
  }
  saveState('cashbackdo_favs', [...favoriteIds]);
  if (activeBank === 'favoritos') renderCards();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SWIPE TO HIDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hidePromo(promoId, wrapEl) {
  hiddenIds.add(promoId);
  saveState('cashbackdo_hidden', [...hiddenIds]);
  // Animate out
  wrapEl.classList.add('hiding');
  setTimeout(() => {
    wrapEl.classList.add('collapse');
    setTimeout(() => renderCards(), 350);
  }, 150);
}

function unhidePromo(promoId) {
  hiddenIds.delete(promoId);
  saveState('cashbackdo_hidden', [...hiddenIds]);
  renderCards();
}

// Touch swipe handler ‚Äî attach to each card wrapper
function initSwipe(el, promoId) {
  let startX = 0, currentX = 0, dragging = false;
  const threshold = 80;

  el.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    currentX = startX;
    dragging = true;
    el.classList.remove('swiping');
  }, { passive: true });

  el.addEventListener('touchmove', e => {
    if (!dragging) return;
    currentX = e.touches[0].clientX;
    const dx = startX - currentX;
    if (dx > 20) {
      el.classList.add('swiping');
      const card = el.querySelector('.promo-card');
      card.style.transform = `translateX(${Math.max(-threshold, -dx)}px)`;
    }
  }, { passive: true });

  el.addEventListener('touchend', () => {
    if (!dragging) return;
    dragging = false;
    const dx = startX - currentX;
    const card = el.querySelector('.promo-card');
    if (dx >= threshold) {
      hidePromo(promoId, el);
    } else {
      card.style.transform = '';
      el.classList.remove('swiping');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMobileMenu() {
  const menu = document.getElementById('mobileMenu');
  const overlay = document.getElementById('mobileMenuOverlay');
  const isOpen = menu.classList.contains('open');
  if (isOpen) {
    closeMobileMenu();
  } else {
    menu.classList.add('open');
    overlay.classList.add('open');
  }
}

function closeMobileMenu() {
  document.getElementById('mobileMenu').classList.remove('open');
  document.getElementById('mobileMenuOverlay').classList.remove('open');
}

// Close settings dropdown when clicking outside it
// Use a flag to prevent the mobile menu "Configuraciones" click from immediately closing it
let _settingsJustOpened = false;
document.addEventListener('click', e => {
  const dd = document.getElementById('settingsDropdown');
  const btn = document.getElementById('settingsBtn');
  if (_settingsJustOpened) { _settingsJustOpened = false; return; }
  if (dd.classList.contains('open') && !dd.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
    dd.classList.remove('open');
    btn.classList.remove('active');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API URL CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setApiUrl() {
  const url = document.getElementById('apiUrlInput').value.trim().replace(/\/$/, '');
  if (!url) return;
  API_BASE = url;
  localStorage.setItem('cashbackdo_api', url);
  loadData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT + AUTO REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadData();
fetchCardCatalog();
restoreSettingsState();
// Refrescar datos cada 5 minutos autom√°ticamente
setInterval(loadData, 5 * 60 * 1000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVICE WORKER REGISTRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        // Check for updates every 30 minutes
        setInterval(() => reg.update(), 30 * 60 * 1000);
      })
      .catch(err => console.warn('SW registration failed:', err));
  });
}
</script>
</body>
</html>
