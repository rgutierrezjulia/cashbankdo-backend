<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CashbackDO â€” Ofertas de Bancos Dominicanos</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1c1c28;
    --border: rgba(255,255,255,0.06);
    --accent: #00e5a0;
    --accent2: #7c5cff;
    --accent3: #ff6b6b;
    --accent4: #ffd166;
    --text: #f0f0f8;
    --muted: #6b6b88;
    --card: #16161f;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 1000; opacity: 0.4;
  }

  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.9); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border); padding: 0 24px;
  }
  .header-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 60px; }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.3rem; letter-spacing: -0.03em; }
  .logo span { color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 10px; }

  .sync-info {
    font-size: 0.72rem; color: var(--muted);
    display: flex; align-items: center; gap: 6px;
  }
  .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: blink 2s infinite; }
  @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
  .sync-dot.stale { background: var(--accent4); animation: none; }
  .sync-dot.error { background: var(--accent3); animation: none; }

  .scrape-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 5px 12px; border-radius: 7px;
    font-size: 0.75rem; cursor: pointer; transition: all 0.18s;
    font-family: 'DM Sans', sans-serif; display: flex; align-items: center; gap: 5px;
  }
  .scrape-btn:hover { border-color: var(--accent); color: var(--accent); }
  .scrape-btn.loading { opacity: 0.6; cursor: not-allowed; }
  .scrape-btn .spin { display: none; animation: spin 1s linear infinite; }
  .scrape-btn.loading .spin { display: inline; }
  .scrape-btn.loading .idle { display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .geo-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 6px 14px; border-radius: 8px;
    font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 6px;
    transition: all 0.2s; font-family: 'DM Sans', sans-serif;
  }
  .geo-btn:hover { border-color: var(--accent); color: var(--accent); }
  .geo-btn.active { border-color: var(--accent); background: rgba(0,229,160,0.1); color: var(--accent); }

  .hero { max-width: 1100px; margin: 0 auto; padding: 48px 24px 32px; }
  .hero h1 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: clamp(2rem, 5vw, 3.2rem); line-height: 1.1; letter-spacing: -0.03em; margin-bottom: 12px; }
  .hero h1 em { font-style: normal; color: var(--accent); }
  .hero p { color: var(--muted); font-size: 0.95rem; max-width: 480px; line-height: 1.6; }

  .stats-row { max-width: 1100px; margin: 0 auto 32px; padding: 0 24px; display: flex; gap: 12px; flex-wrap: wrap; }
  .stat-chip { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px 20px; flex: 1; min-width: 130px; }
  .stat-chip .num { font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .stat-chip .lbl { font-size: 0.75rem; color: var(--muted); }
  .stat-chip.green .num { color: var(--accent); }
  .stat-chip.yellow .num { color: var(--accent4); }
  .stat-chip.purple .num { color: var(--accent2); }
  .stat-chip.blue .num { color: #48cae4; }

  .controls { max-width: 1100px; margin: 0 auto 24px; padding: 0 24px; display: flex; flex-direction: column; gap: 10px; }
  .cat-filter { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
  .cat-filter::-webkit-scrollbar { display: none; }
  .cat-btn { padding: 7px 16px; border-radius: 99px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 0.82rem; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.18s; white-space: nowrap; flex-shrink: 0; }
  .cat-btn.active { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }
  .mis-bank-btn { border-color: var(--accent2) !important; color: var(--accent2) !important; }
  .bank-filter { display: flex; gap: 6px; flex-wrap: wrap; }
  .bank-btn { padding: 5px 12px; border-radius: 99px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 0.75rem; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.18s; white-space: nowrap; }
  .bank-btn.active-all { background: var(--surface2); border-color: var(--text); color: var(--text); }

  .main { max-width: 1200px; margin: 0 auto; padding: 0 24px 60px; }

  /* Google Ads banner */
  .ads-banner { width: 100%; background: var(--surface); border: 1px dashed rgba(255,255,255,0.1); border-radius: 12px; min-height: 90px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; overflow: hidden; }
  .ads-banner-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }

  /* Promos grid â€” 3 columns desktop */
  .cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  @media (max-width: 900px) { .cards-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; } }
  @media (max-width: 600px) { .cards-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; } }

  /* Drawer backdrop */
  .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
  .drawer-overlay.open { opacity: 1; pointer-events: all; }

  /* Slide-in drawer (right) */
  .side-drawer { position: fixed; top: 0; right: 0; bottom: 0; width: min(400px, 100vw); background: var(--surface); border-left: 1px solid var(--border); z-index: 201; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: flex; flex-direction: column; overflow-y: auto; }
  .side-drawer.open { transform: translateX(0); }
  .drawer-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface); z-index: 1; }
  .drawer-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
  .drawer-close { background: none; border: none; color: var(--muted); font-size: 1.3rem; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: color 0.15s; }
  .drawer-close:hover { color: var(--text); }
  .drawer-body { padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 20px; }

  /* Settings dropdown */
  .settings-dropdown { position: fixed; top: 68px; right: 24px; width: min(340px, calc(100vw - 32px)); background: var(--surface); border: 1px solid var(--border); border-radius: 16px; z-index: 300; box-shadow: 0 20px 60px rgba(0,0,0,0.5); display: none; padding: 16px; }
  .settings-dropdown.open { display: block; animation: fadeDown 0.18s ease; }
  @keyframes fadeDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }

  /* Header drawer/settings buttons */
  .icon-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.18s; font-family: 'DM Sans', sans-serif; white-space: nowrap; }
  .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
  .icon-btn.active { border-color: var(--accent2); color: var(--accent2); background: rgba(124,92,255,0.1); }
  .promo-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; transition: all 0.22s; position: relative; overflow: hidden; animation: fadeUp 0.4s ease both; }
  .promo-card:hover { border-color: rgba(255,255,255,0.14); transform: translateY(-1px); }
  .promo-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; border-radius: 16px 16px 0 0; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .bank-tag { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; font-weight: 500; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
  .bank-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .pct-badge { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.4rem; color: var(--accent); line-height: 1; }
  .pct-badge small { font-size: 0.65rem; font-weight: 400; color: var(--muted); display: block; text-align: right; font-family: 'DM Sans', sans-serif; }
  .card-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; margin-bottom: 8px; line-height: 1.3; }
  .card-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.5; margin-bottom: 14px; }
  .card-meta { display: flex; flex-wrap: wrap; gap: 8px; }
  .meta-chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 5px 10px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; color: var(--muted); }
  .meta-chip .val { color: var(--text); font-weight: 500; }
  .meta-chip.hl { border-color: rgba(0,229,160,0.3); background: rgba(0,229,160,0.06); }
  .meta-chip.hl .val { color: var(--accent); }
  .card-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
  .validity { font-size: 0.75rem; color: var(--muted); display: flex; align-items: center; gap: 5px; }
  .days-badge { border-radius: 5px; padding: 2px 7px; font-weight: 500; font-size: 0.72rem; }
  .days-badge.active { background: rgba(0,229,160,0.12); color: var(--accent); }
  .days-badge.soon { background: rgba(255,209,102,0.12); color: var(--accent4); }
  .days-badge.expired { background: rgba(255,107,107,0.1); color: var(--accent3); }
  .card-link { font-size: 0.75rem; color: var(--muted); text-decoration: none; padding: 5px 12px; border: 1px solid var(--border); border-radius: 7px; transition: all 0.18s; }
  .card-link:hover { border-color: var(--accent); color: var(--accent); }
  .tags-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
  .tag { font-size: 0.68rem; padding: 3px 8px; border-radius: 5px; font-weight: 500; }
  .tag.online { background: rgba(124,92,255,0.15); color: var(--accent2); }
  .tag.presencial { background: rgba(0,119,182,0.15); color: #48cae4; }
  .tag.aÃ©reo { background: rgba(255,209,102,0.15); color: var(--accent4); }
  .tag.entretenimiento { background: rgba(255,107,107,0.15); color: var(--accent3); }
  .tag.supermercado,.tag.restaurante { background: rgba(0,229,160,0.1); color: var(--accent); }
  .tag.crÃ©dito { background: rgba(0,229,160,0.08); color: var(--accent); }
  .tag.dÃ©bito { background: rgba(255,255,255,0.06); color: var(--muted); }

  /* Widget (used inside drawers) */
  .widget { background: var(--surface2); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
  .widget-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.9rem; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }

  /* Compact promo cards on mobile â€” show 9 at once (3Ã—3) */
  @media (max-width: 600px) {
    .hero { padding: 20px 16px 16px; }
    .hero h1 { font-size: 1.4rem; }
    .hero p { display: none; }
    .stats-row { margin-bottom: 16px; gap: 8px; }
    .stat-chip { padding: 8px 10px; min-width: 70px; }
    .stat-chip .num { font-size: 1.1rem; }
    .stat-chip .lbl { font-size: 0.62rem; }
    .controls { margin-bottom: 14px; gap: 8px; }
    .ads-banner { min-height: 60px; margin-bottom: 12px; }
    .main { padding: 0 10px 40px; }
    .promo-card { padding: 10px 8px 8px; border-radius: 12px; }
    .card-title { font-size: 0.72rem; line-height: 1.25; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-desc, .tags-row, .card-meta, .card-notes { display: none; }
    .bank-tag { font-size: 0.6rem; gap: 5px; }
    .bank-dot { width: 6px; height: 6px; }
    .pct-badge { font-size: 1rem; }
    .pct-badge small { font-size: 0.55rem; }
    .card-bottom { margin-top: 6px; padding-top: 6px; }
    .days-badge { font-size: 0.6rem; padding: 1px 5px; }
    .card-link { font-size: 0.6rem; padding: 3px 7px; }
  }

  .add-card-form { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
  .add-btn { background: var(--accent); color: #000; border: none; border-radius: 8px; padding: 9px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: opacity 0.18s; }
  .add-btn:hover { opacity: 0.85; }

  /* Location */
  .location-display { background: var(--surface2); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
  .location-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .location-name { font-size: 0.85rem; font-weight: 500; }
  .location-sub { font-size: 0.72rem; color: var(--muted); }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; position: relative; }
  .pulse-dot.active::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 1.5px solid var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1.8); opacity: 0; } }
  .timer-bar-wrap { margin-top: 8px; }
  .timer-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 4px; display: flex; justify-content: space-between; }
  .timer-bar { height: 4px; background: var(--surface); border-radius: 99px; overflow: hidden; }
  .timer-fill { height: 100%; background: var(--accent); border-radius: 99px; transition: width 1s linear; }
  .nearby-promo { background: linear-gradient(135deg, rgba(0,229,160,0.08), rgba(124,92,255,0.08)); border: 1px solid rgba(0,229,160,0.2); border-radius: 10px; padding: 12px; font-size: 0.8rem; line-height: 1.5; margin-bottom: 12px; }
  .nearby-promo strong { color: var(--accent); }

  /* Toast */
  .notif-toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface2); border: 1px solid rgba(0,229,160,0.3); border-radius: 14px; padding: 16px 20px; max-width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 9999; display: none; }
  .notif-toast.show { display: block; animation: slideIn 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes slideIn { from { transform: translateX(100%) translateY(20px); opacity: 0; } to { transform: translateX(0) translateY(0); opacity: 1; } }
  .notif-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .notif-bank { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); font-weight: 700; }
  .notif-msg { font-size: 0.82rem; line-height: 1.5; }
  .notif-sub { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
  .notif-close { position: absolute; top: 10px; right: 12px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; }

  /* Loading skeleton */
  .skeleton { background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
  @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }
  .sk-card { height: 180px; border-radius: 16px; margin-bottom: 14px; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .big { font-size: 3rem; margin-bottom: 12px; }

  /* Network badges */
  .net-badge { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 5px; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.03em; }
  .net-badge.visa { background: rgba(26,95,205,0.15); color: #5b9cf6; }
  .net-badge.mastercard { background: rgba(235,77,47,0.15); color: #f5856d; }
  .net-badge.amex { background: rgba(0,180,135,0.15); color: #2dce9b; }
  .type-badge { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 5px; font-size: 0.65rem; font-weight: 500; }
  .type-badge.credito { background: rgba(0,229,160,0.08); color: var(--accent); }
  .type-badge.debito { background: rgba(255,255,255,0.06); color: var(--muted); }

  /* Card item improved */
  .card-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .card-item:last-child { border-bottom: none; }
  .card-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .card-info { flex: 1; min-width: 0; }
  .card-name { font-size: 0.8rem; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-badges { display: flex; gap: 4px; flex-wrap: wrap; }
  .card-promos { font-size: 0.65rem; font-weight: 700; min-width: 20px; height: 20px; padding: 0 5px; border-radius: 99px; display: flex; align-items: center; justify-content: center; background: var(--accent); color: #000; flex-shrink: 0; }
  .card-promos.zero { background: var(--surface2); color: var(--muted); }
  .card-del { background: none; border: none; color: var(--muted); cursor: pointer; padding: 3px 5px; border-radius: 5px; font-size: 0.8rem; flex-shrink: 0; transition: color 0.15s; }
  .card-del:hover { color: var(--accent3); }

  /* Apple Wallet import button */
  .wallet-import-btn { display: flex; align-items: center; justify-content: center; gap: 7px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px; color: var(--text); font-size: 0.82rem; cursor: pointer; transition: all 0.18s; font-family: 'DM Sans', sans-serif; width: 100%; }
  .wallet-import-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; width: 100%; max-width: 480px; max-height: 85vh; display: flex; flex-direction: column; }
  .modal-header { padding: 20px 20px 14px; border-bottom: 1px solid var(--border); }
  .modal-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .modal-search { background: var(--surface2); border: 1px solid var(--border); border-radius: 9px; padding: 9px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; width: 100%; transition: border-color 0.18s; }
  .modal-search:focus { border-color: var(--accent); }
  .modal-list { flex: 1; overflow-y: auto; padding: 10px 12px; }
  .modal-item { display: flex; align-items: center; gap: 10px; padding: 9px 8px; border-radius: 9px; cursor: pointer; transition: background 0.15s; }
  .modal-item:hover { background: var(--surface2); }
  .modal-item input[type=checkbox] { accent-color: var(--accent); width: 15px; height: 15px; flex-shrink: 0; cursor: pointer; }
  .modal-item-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
  .modal-item-name { flex: 1; font-size: 0.82rem; }
  .modal-item-badges { display: flex; gap: 4px; }
  .modal-bank-header { font-size: 0.7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; padding: 12px 8px 4px; }
  .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 10px; }
  .modal-count { font-size: 0.82rem; color: var(--muted); }
  .modal-add-btn { background: var(--accent); color: #000; border: none; border-radius: 8px; padding: 9px 18px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: opacity 0.18s; }
  .modal-add-btn:hover { opacity: 0.85; }
  .modal-add-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .modal-close { background: none; border: none; color: var(--muted); font-size: 1.2rem; cursor: pointer; padding: 4px; }

  /* Add card form dropdowns row */
  .add-card-form select { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; transition: border-color 0.18s; width: 100%; }
  .add-card-form select:focus { border-color: var(--accent); }
  .add-card-form option { background: #1c1c28; }

  /* API config banner */
  .api-banner { background: rgba(255,209,102,0.08); border: 1px solid rgba(255,209,102,0.2); border-radius: 12px; padding: 12px 16px; font-size: 0.8rem; color: var(--accent4); margin-bottom: 16px; line-height: 1.6; }
  .api-banner strong { display: block; margin-bottom: 4px; }
  .api-input-row { display: flex; gap: 8px; margin-top: 8px; }
  .api-input-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 7px; padding: 7px 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; outline: none; }
  .api-input-row button { background: var(--accent4); color: #000; border: none; border-radius: 7px; padding: 7px 12px; font-size: 0.78rem; font-weight: 700; cursor: pointer; font-family: 'Syne', sans-serif; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="logo">Cashback<span>DO</span></div>
    </div>
    <div class="header-right">
      <div class="sync-info">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncText">Conectando...</span>
      </div>
      <button class="scrape-btn" id="scrapeBtn" onclick="triggerScrape()">
        <span class="idle">ğŸ”„</span>
        <span class="spin">âŸ³</span>
      </button>
      <button class="icon-btn" id="walletBtn" onclick="toggleWalletDrawer()">ğŸ’³ Mis Tarjetas</button>
      <button class="icon-btn" id="settingsBtn" onclick="toggleSettings()">âš™ï¸</button>
    </div>
  </div>
</header>

<div class="hero">
  <h1>Cashback <em>bancario</em><br>en RepÃºblica Dominicana</h1>
  <p>Datos extraÃ­dos automÃ¡ticamente cada dÃ­a de las bases legales de todos los bancos dominicanos. Siempre actualizado.</p>
</div>

<div class="stats-row">
  <div class="stat-chip green"><div class="num" id="statActive">â€”</div><div class="lbl">Vigentes hoy</div></div>
  <div class="stat-chip yellow"><div class="num" id="statUpcoming">â€”</div><div class="lbl">PrÃ³ximos 15 dÃ­as</div></div>
  <div class="stat-chip purple"><div class="num" id="statBanks">â€”</div><div class="lbl">Bancos</div></div>
  <div class="stat-chip blue"><div class="num" id="statTotal">â€”</div><div class="lbl">Total promos</div></div>
</div>

<div class="controls">
  <div class="cat-filter" id="catFilter">
    <button class="cat-btn active" onclick="setCategory('all',this)">Todas</button>
    <button class="cat-btn" onclick="setCategory('shopping',this)">ğŸ›ï¸ Shopping</button>
    <button class="cat-btn" onclick="setCategory('supermercado',this)">ğŸ›’ Super & Farmacia</button>
    <button class="cat-btn" onclick="setCategory('restaurante',this)">ğŸ½ï¸ Bares y Restaurantes</button>
    <button class="cat-btn" onclick="setCategory('entretenimiento',this)">ğŸ­ Entretenimiento</button>
    <button class="cat-btn" onclick="setCategory('viaje',this)">âœˆï¸ Viajes</button>
    <button class="cat-btn" onclick="setCategory('educaciÃ³n',this)">ğŸ“š EducaciÃ³n</button>
    <button class="cat-btn" onclick="setCategory('otro',this)">ğŸ“¦ Otras</button>
  </div>
  <div class="bank-filter" id="bankFilter">
    <button class="bank-btn active-all" data-bank="all" onclick="setBank('all',this)">Todos</button>
    <button class="bank-btn mis-bank-btn" data-bank="mis-productos" onclick="setBank('mis-productos',this)">â­ Mis Productos</button>
  </div>
</div>

<div class="main">
  <div id="apiBanner" class="api-banner" style="display:none">
    <strong>âš™ï¸ Configura el servidor backend</strong>
    Ingresa la URL de tu servidor CashbackDO para ver las promos en vivo.
    <div class="api-input-row">
      <input id="apiUrlInput" type="text" placeholder="http://localhost:3001" />
      <button onclick="setApiUrl()">Conectar</button>
    </div>
  </div>

  <!-- Google Ads -->
  <div class="ads-banner">
    <!-- Google AdSense: reemplaza con tu cÃ³digo de unidad de anuncio -->
    <span class="ads-banner-label">Publicidad</span>
  </div>

  <div class="cards-grid" id="cardsList">
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
  </div>
</div>

<!-- Drawer backdrop -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeAllDrawers()"></div>

<!-- Mis Tarjetas drawer -->
<div class="side-drawer" id="walletDrawer">
  <div class="drawer-header">
    <div class="drawer-title">ğŸ’³ Mis Tarjetas</div>
    <button class="drawer-close" onclick="closeAllDrawers()">âœ•</button>
  </div>
  <div class="drawer-body">
    <div id="walletList"></div>
    <div class="add-card-form">
      <select id="cardBank" onchange="onBankChange()">
        <option value="">Banco...</option>
      </select>
      <select id="cardName" disabled>
        <option value="">Selecciona banco primero</option>
      </select>
      <button class="add-btn" onclick="addCard()">+ Agregar tarjeta</button>
      <button class="wallet-import-btn" onclick="openWalletModal()">ğŸ Importar desde Apple Wallet</button>
    </div>
  </div>
</div>

<!-- Settings dropdown -->
<div class="settings-dropdown" id="settingsDropdown">
  <div class="widget-title" style="margin-bottom:12px">ğŸ“ Detector de Lugar</div>
  <div class="location-display">
    <div class="location-row">
      <div class="pulse-dot" id="pulseDot" style="background:var(--muted)"></div>
      <div>
        <div class="location-name" id="locName">UbicaciÃ³n no activa</div>
        <div class="location-sub" id="locSub">Activa para ver promos cercanas</div>
      </div>
    </div>
    <div class="timer-bar-wrap" id="timerWrap" style="display:none">
      <div class="timer-label"><span>Tiempo en lugar</span><span id="timerLabel">0:00 / 5:00</span></div>
      <div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:0%"></div></div>
    </div>
  </div>
  <div id="nearbyPromo" style="display:none" class="nearby-promo"></div>
  <button class="geo-btn" id="geoBtn" style="width:100%;justify-content:center;margin-bottom:16px" onclick="toggleGeo()">Activar ubicaciÃ³n</button>
  <div style="border-top:1px solid var(--border);padding-top:14px;margin-top:4px">
    <div class="widget-title" style="margin-bottom:8px">ğŸ“Š Ãšltimo Scraping</div>
    <div id="scrapeStats" style="font-size:0.8rem;color:var(--muted);line-height:1.8">Cargando...</div>
  </div>
</div>

<!-- Apple Wallet Import Modal -->
<div class="modal-overlay" id="walletModal" onclick="closeWalletModalOutside(event)">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">
        ğŸ Importar desde Apple Wallet
        <button class="modal-close" onclick="closeWalletModal()" style="margin-left:auto">âœ•</button>
      </div>
      <input class="modal-search" id="modalSearch" type="text" placeholder="Buscar tarjeta..." oninput="filterModalCards()" />
    </div>
    <div class="modal-list" id="modalList"></div>
    <div class="modal-footer">
      <span class="modal-count" id="modalCount">0 seleccionadas</span>
      <button class="modal-add-btn" id="modalAddBtn" onclick="addModalSelected()" disabled>AÃ±adir seleccionadas</button>
    </div>
  </div>
</div>

<div class="notif-toast" id="notifToast">
  <button class="notif-close" onclick="closeToast()">âœ•</button>
  <div class="notif-header"><span>ğŸ””</span><span class="notif-bank" id="toastBank"></span></div>
  <div class="notif-msg" id="toastMsg"></div>
  <div class="notif-sub" id="toastSub"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sanitizar API_BASE: solo host, sin paths
const _savedApi = localStorage.getItem('cashbackdo_api') || 'https://cashbankdo-backend-production.up.railway.app';
let API_BASE = (() => { try { const u = new URL(_savedApi); return u.origin; } catch { return 'https://cashbankdo-backend-production.up.railway.app'; } })();
const ADMIN_KEY = localStorage.getItem('cashbackdo_adminkey') || '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allPromos = [];
let banks = [];
let cardCatalog = {};
let activeCategory = 'all';
let activeBank = 'all';

// Mapeo de valor de categorÃ­a a tags del backend
const CATEGORY_TAGS = {
  shopping:          ['retail', 'online'],
  supermercado:      ['supermercado', 'farmacia'],
  restaurante:       ['restaurante', 'bebidas'],
  entretenimiento:   ['entretenimiento'],
  viaje:             ['viaje'],
  'educaciÃ³n':       ['educaciÃ³n'],
  otro:              ['otro', 'combustible'],
};
let geoActive = false;
let timerSec = 0;
let timerRef = null;
let walletCards = JSON.parse(localStorage.getItem('cashbackdo_wallet') || '[]');
// Modal state
let modalSelected = new Set();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPromos() {
  const params = new URLSearchParams();
  if (activeBank !== 'all' && activeBank !== 'mis-productos') params.append('bank', activeBank);
  const res = await fetch(`${API_BASE}/api/promos?${params}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchStats() {
  const res = await fetch(`${API_BASE}/api/stats`);
  if (!res.ok) throw new Error();
  return res.json();
}

async function fetchBanks() {
  const res = await fetch(`${API_BASE}/api/banks`);
  if (!res.ok) throw new Error();
  return res.json();
}

async function fetchCardCatalog() {
  try {
    const res = await fetch(`${API_BASE}/api/card-catalog`);
    if (!res.ok) { console.warn('card-catalog status:', res.status); return; }
    const data = await res.json();
    if (data && Object.keys(data).length > 0) {
      cardCatalog = data;
      populateBankSelect();
    } else {
      console.warn('card-catalog vino vacÃ­o');
    }
  } catch (e) {
    console.error('fetchCardCatalog error:', e);
  }
}

function populateBankSelect() {
  const sel = document.getElementById('cardBank');
  sel.innerHTML = '<option value="">Banco...</option>' +
    Object.entries(cardCatalog).map(([id, bank]) =>
      `<option value="${id}">${bank.name}</option>`
    ).join('');
}

function onBankChange() {
  const bankId = document.getElementById('cardBank').value;
  const cardSel = document.getElementById('cardName');
  if (!bankId || !cardCatalog[bankId]) {
    cardSel.innerHTML = '<option value="">Selecciona banco primero</option>';
    cardSel.disabled = true;
    return;
  }
  const cards = cardCatalog[bankId].cards || [];
  cardSel.innerHTML = '<option value="">Tarjeta...</option>' +
    cards.map(c => `<option value="${c.id}" data-network="${c.network}" data-type="${c.type}">${c.name}</option>`).join('');
  cardSel.disabled = false;
}

async function matchWallet() {
  if (walletCards.length === 0) return [];
  const res = await fetch(`${API_BASE}/api/match-wallet`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cards: walletCards })
  });
  if (!res.ok) return [];
  const data = await res.json();
  return data.matches;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  try {
    const [promosData, statsData, banksData] = await Promise.all([
      fetchPromos(), fetchStats(), fetchBanks()
    ]);

    allPromos = promosData.promos;
    banks = banksData;

    // Update stats
    document.getElementById('statActive').textContent = promosData.meta.stats?.active || allPromos.filter(p => p.isActive).length;
    document.getElementById('statUpcoming').textContent = promosData.meta.stats?.upcoming || allPromos.filter(p => p.isUpcoming).length;
    document.getElementById('statBanks').textContent = banksData.filter(b => b.promoCount > 0).length;
    document.getElementById('statTotal').textContent = promosData.meta.stats?.total || allPromos.length;

    // Sync status
    setSyncStatus('ok', statsData.lastUpdated);

    // Bank filter buttons
    renderBankFilter(banksData);

    // Scrape stats widget
    renderScrapeStats(statsData);

    // Render cards
    renderCards();
    renderWallet();

    document.getElementById('apiBanner').style.display = 'none';
  } catch (err) {
    console.error('API error:', err);
    setSyncStatus('error', null);
    document.getElementById('apiBanner').style.display = 'block';
    document.getElementById('apiUrlInput').value = API_BASE;
    // Show fallback data
    renderCards();
  }
}

function setSyncStatus(status, lastUpdated) {
  const dot = document.getElementById('syncDot');
  const text = document.getElementById('syncText');
  dot.className = 'sync-dot';

  if (status === 'ok') {
    const ago = lastUpdated ? timeAgo(lastUpdated) : 'reciÃ©n';
    text.textContent = `Actualizado ${ago}`;
    dot.classList.add('');
    dot.style.background = 'var(--accent)';
  } else if (status === 'error') {
    text.textContent = 'Sin conexiÃ³n al servidor';
    dot.style.background = 'var(--accent3)';
  }
}

function timeAgo(iso) {
  const diff = Date.now() - new Date(iso);
  const h = Math.floor(diff / 3600000);
  const m = Math.floor(diff / 60000);
  if (h > 0) return `hace ${h}h`;
  if (m > 0) return `hace ${m}min`;
  return 'ahora mismo';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCards() {
  const list = document.getElementById('cardsList');

  if (allPromos.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="big">ğŸ¦</div><div>No hay promociones. El servidor estÃ¡ procesando...</div></div>`;
    return;
  }

  // Solo mostrar activas y prÃ³ximas (ocultar expiradas)
  let filtered = allPromos.filter(p => p.isActive || p.isUpcoming);

  // Filtrar por "Mis Productos" â€” promos de los bancos del wallet del usuario
  if (activeBank === 'mis-productos') {
    if (walletCards.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">ğŸ’³</div><div>Agrega tus tarjetas en el panel de la derecha para ver tus promos personalizadas</div></div>`;
      return;
    }
    filtered = filtered.filter(p =>
      walletCards.some(card => {
        const bankId = card.bankId || card.bank?.toLowerCase().replace(/\s+/g, '');
        const bankMatch = p.bankId === bankId ||
                          p.bank?.toLowerCase().includes(card.bank?.toLowerCase()) ||
                          p.bankId === card.bank?.toLowerCase();
        if (!bankMatch) return false;
        const cardType = card.type || card.tipo;
        if (cardType && p.cardTypes?.length > 0) {
          if (!p.cardTypes.includes(cardType)) return false;
        }
        return true;
      })
    );
    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="big">ğŸ”</div><div>No hay promos activas para tus tarjetas en este momento</div></div>`;
      return;
    }
  }

  // Filtrar por categorÃ­a
  if (activeCategory !== 'all') {
    const tags = CATEGORY_TAGS[activeCategory] || [activeCategory];
    filtered = filtered.filter(p => p.categories?.some(c => tags.includes(c)));
  }

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="big">ğŸ”</div><div>No hay promos en esta categorÃ­a</div></div>`;
    return;
  }

  const rendered = filtered.map((p, i) => {
    const color = banks.find(b => b.id === p.bankId)?.color || '#888';
    const tags = [...(p.categories || []), ...(p.cardTypes || [])];

    let daysBadge = '';
    if (p.isActive) {
      const d = p.daysUntilExpiry;
      daysBadge = `<span class="days-badge active">${d != null ? (d === 0 ? 'Hoy termina' : `${d} dÃ­as restantes`) : 'Vigente'}</span>`;
    } else if (p.isUpcoming) {
      daysBadge = `<span class="days-badge soon">Empieza en ${p.daysUntilStart} dÃ­a${p.daysUntilStart !== 1 ? 's' : ''}</span>`;
    } else {
      daysBadge = `<span class="days-badge expired">Expirada</span>`;
    }

    const tagsHtml = tags.slice(0, 5).map(t => `<span class="tag ${t}">${t}</span>`).join('');
    const establishments = Array.isArray(p.establishments)
      ? p.establishments.slice(0, 5).join(', ')
      : p.establishments || '';

    return `<div class="promo-card" style="animation-delay:${i*0.05}s; --bcolor:${color}">
      <style>.promo-card:nth-child(${i+1})::before { background: linear-gradient(90deg, ${color}, ${color}88); }</style>
      <div class="card-top">
        <div class="bank-tag">
          <div class="bank-dot" style="background:${color}"></div>
          ${p.bank}
        </div>
        <div class="pct-badge">${p.percentage || 'â€”'}<small>${p.promoType || ''}</small></div>
      </div>
      <div class="card-title">${p.title || 'PromociÃ³n'}</div>
      ${tags.length ? `<div class="tags-row">${tagsHtml}</div>` : ''}
      <div class="card-desc">${p.description || ''}</div>
      <div class="card-meta">
        ${p.minimumSpend ? `<div class="meta-chip"><span>ğŸª™ MÃ­nimo</span><span class="val">${p.minimumSpend}</span></div>` : ''}
        ${p.maxReturn ? `<div class="meta-chip hl"><span>ğŸ¯ Tope</span><span class="val">${p.maxReturn}</span></div>` : ''}
        ${p.validFrom ? `<div class="meta-chip"><span>ğŸ“…</span><span class="val">${fmt(p.validFrom)} â†’ ${fmt(p.validUntil)}</span></div>` : ''}
        ${p.creditingDate ? `<div class="meta-chip"><span>ğŸ’°</span><span class="val">${p.creditingDate}</span></div>` : ''}
        ${establishments ? `<div class="meta-chip" style="flex:1"><span>ğŸª</span><span class="val">${establishments}</span></div>` : ''}
      </div>
      ${p.notes ? `<div class="card-desc" style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">â„¹ï¸ ${p.notes}</div>` : ''}
      <div class="card-bottom">
        <div class="validity">${daysBadge}</div>
        <a class="card-link" href="${p.sourceUrl || '#'}" target="_blank">Ver T&C â†—</a>
      </div>
    </div>`;
  }).join('');

  list.innerHTML = rendered;
}

function fmt(s) {
  if (!s) return '';
  const [y,m,d] = s.split('-');
  const months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
  return `${parseInt(d)} ${months[parseInt(m)-1]}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANK FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBankFilter(banks) {
  const filter = document.getElementById('bankFilter');
  // Keep the static Todos + Mis Productos buttons, only replace the bank buttons after them
  const bankBtns = banks.filter(b => b.promoCount > 0).map(b =>
    `<button class="bank-btn" data-bank="${b.id}" onclick="setBank('${b.id}',this)"
      style="--bc:${b.color}">${b.name}</button>`
  ).join('');
  // Remove old bank buttons (keep first 2 static ones)
  const staticBtns = filter.querySelectorAll('[data-bank="all"], [data-bank="mis-productos"]');
  filter.innerHTML =
    `<button class="bank-btn active-all" data-bank="all" onclick="setBank('all',this)">Todos</button>` +
    `<button class="bank-btn mis-bank-btn" data-bank="mis-productos" onclick="setBank('mis-productos',this)">â­ Mis Productos</button>` +
    bankBtns;
}

function setCategory(cat, el) {
  activeCategory = cat;
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderCards();
}

function setBank(bank, el) {
  activeBank = bank;
  document.querySelectorAll('.bank-btn').forEach(b => {
    b.classList.remove('active-all');
    b.style.background = '';
    b.style.borderColor = '';
    b.style.color = '';
  });
  el.classList.add('active-all');
  if (bank === 'mis-productos') {
    el.style.background = 'var(--accent2)';
    el.style.borderColor = 'var(--accent2)';
    el.style.color = '#fff';
  } else if (bank !== 'all') {
    const bc = banks.find(b => b.id === bank)?.color || '';
    el.style.background = bc;
    el.style.borderColor = bc;
    el.style.color = '#000';
  }
  loadData();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WALLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getNetworkClass(network) {
  if (!network) return '';
  const n = network.toLowerCase();
  if (n.includes('visa')) return 'visa';
  if (n.includes('mastercard')) return 'mastercard';
  if (n.includes('american') || n.includes('amex')) return 'amex';
  return '';
}

function getNetworkLabel(network) {
  if (!network) return '';
  const n = network.toLowerCase();
  if (n.includes('visa')) return 'Visa';
  if (n.includes('mastercard')) return 'MC';
  if (n.includes('american') || n.includes('amex')) return 'Amex';
  return network;
}

async function renderWallet() {
  const wl = document.getElementById('walletList');
  if (walletCards.length === 0) {
    wl.innerHTML = '<div style="font-size:0.8rem;color:var(--muted);padding:8px 0 12px">Agrega tus tarjetas para ver promos personalizadas</div>';
    return;
  }

  let matches = [];
  try { matches = await matchWallet(); } catch {}

  wl.innerHTML = walletCards.map((c, i) => {
    const match = matches[i];
    const count = match?.promoCount || 0;
    // Support both new format (bankId) and old format (bank)
    const bankId = c.bankId || '';
    const bankColor = (bankId && cardCatalog[bankId]?.color) ||
                      banks.find(b => b.name === c.bank || b.id === bankId)?.color || '#555';
    const cardType = c.type || c.tipo || '';
    const network = c.network || '';
    const netClass = getNetworkClass(network);
    const netLabel = getNetworkLabel(network);
    const typeClass = cardType === 'crÃ©dito' ? 'credito' : 'debito';

    return `<div class="card-item">
      <div class="card-dot" style="background:${bankColor}"></div>
      <div class="card-info">
        <div class="card-name">${c.name}</div>
        <div class="card-badges">
          ${netLabel ? `<span class="net-badge ${netClass}">${netLabel}</span>` : ''}
          ${cardType ? `<span class="type-badge ${typeClass}">${cardType}</span>` : ''}
        </div>
      </div>
      <div class="card-promos ${count === 0 ? 'zero' : ''}">${count}</div>
      <button class="card-del" onclick="removeCard(${i})" title="Eliminar">âœ•</button>
    </div>`;
  }).join('');
}

function removeCard(i) {
  walletCards.splice(i, 1);
  localStorage.setItem('cashbackdo_wallet', JSON.stringify(walletCards));
  renderWallet();
  if (activeBank === 'mis-productos') renderCards();
}

function addCard() {
  const bankId = document.getElementById('cardBank').value;
  const cardSel = document.getElementById('cardName');
  const cardId = cardSel.value;
  if (!bankId || !cardId) return;

  const selectedOpt = cardSel.options[cardSel.selectedIndex];
  const network = selectedOpt.dataset.network || '';
  const type = selectedOpt.dataset.type || '';
  const name = selectedOpt.text;
  const bankName = cardCatalog[bankId]?.name || bankId;

  // Avoid duplicates
  if (walletCards.some(c => c.cardId === cardId)) return;

  walletCards.push({ bankId, cardId, name, bank: bankName, network, type });
  localStorage.setItem('cashbackdo_wallet', JSON.stringify(walletCards));

  document.getElementById('cardBank').value = '';
  document.getElementById('cardName').innerHTML = '<option value="">Selecciona banco primero</option>';
  document.getElementById('cardName').disabled = true;
  renderWallet();
  if (activeBank === 'mis-productos') renderCards();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLE WALLET MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openWalletModal() {
  modalSelected.clear();
  document.getElementById('modalSearch').value = '';
  renderModalList('');
  document.getElementById('walletModal').classList.add('open');
  document.getElementById('modalSearch').focus();
}

function closeWalletModal() {
  document.getElementById('walletModal').classList.remove('open');
}

function closeWalletModalOutside(e) {
  if (e.target === document.getElementById('walletModal')) closeWalletModal();
}

function renderModalList(query) {
  const list = document.getElementById('modalList');
  const q = query.toLowerCase().trim();
  let html = '';

  Object.entries(cardCatalog).forEach(([bankId, bank]) => {
    const filtered = bank.cards.filter(c =>
      !q || c.name.toLowerCase().includes(q) || bank.name.toLowerCase().includes(q)
    );
    if (!filtered.length) return;

    html += `<div class="modal-bank-header" style="color:${bank.color}">${bank.name}</div>`;
    filtered.forEach(c => {
      const checked = modalSelected.has(c.id) ? 'checked' : '';
      const netClass = getNetworkClass(c.network);
      const netLabel = getNetworkLabel(c.network);
      const typeClass = c.type === 'crÃ©dito' ? 'credito' : 'debito';
      html += `<label class="modal-item">
        <input type="checkbox" ${checked} onchange="toggleModalCard('${bankId}','${c.id}')" />
        <div class="modal-item-dot" style="background:${bank.color}"></div>
        <span class="modal-item-name">${c.name}</span>
        <div class="modal-item-badges">
          ${netLabel ? `<span class="net-badge ${netClass}">${netLabel}</span>` : ''}
          <span class="type-badge ${typeClass}">${c.type}</span>
        </div>
      </label>`;
    });
  });

  list.innerHTML = html || '<div style="padding:20px;text-align:center;color:var(--muted)">Sin resultados</div>';
  updateModalCount();
}

function filterModalCards() {
  renderModalList(document.getElementById('modalSearch').value);
}

function toggleModalCard(bankId, cardId) {
  if (modalSelected.has(cardId)) {
    modalSelected.delete(cardId);
  } else {
    modalSelected.add(cardId);
  }
  updateModalCount();
}

function updateModalCount() {
  const n = modalSelected.size;
  document.getElementById('modalCount').textContent = `${n} tarjeta${n !== 1 ? 's' : ''} seleccionada${n !== 1 ? 's' : ''}`;
  document.getElementById('modalAddBtn').disabled = n === 0;
}

function addModalSelected() {
  let added = 0;
  Object.entries(cardCatalog).forEach(([bankId, bank]) => {
    bank.cards.forEach(c => {
      if (!modalSelected.has(c.id)) return;
      if (walletCards.some(w => w.cardId === c.id)) return; // skip duplicates
      walletCards.push({ bankId, cardId: c.id, name: c.name, bank: bank.name, network: c.network, type: c.type });
      added++;
    });
  });

  localStorage.setItem('cashbackdo_wallet', JSON.stringify(walletCards));
  closeWalletModal();
  if (added > 0) {
    renderWallet();
    if (activeBank === 'mis-productos') renderCards();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRAPE STATS WIDGET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScrapeStats(stats) {
  const el = document.getElementById('scrapeStats');
  if (!stats.lastUpdated) { el.textContent = 'Sin datos aÃºn'; return; }
  const history = stats.scrapeHistory || [];
  const last = history[0];
  el.innerHTML = `
    <div style="margin-bottom:6px"><span style="color:var(--text)">Ãšltima actualizaciÃ³n</span><br>${new Date(stats.lastUpdated).toLocaleString('es-DO')}</div>
    <div style="margin-bottom:6px"><span style="color:var(--text)">PrÃ³xima corrida</span><br>${new Date(stats.nextScrape).toLocaleString('es-DO')}</div>
    ${last ? `<div><span style="color:var(--text)">Promos nuevas (Ãºltimo run)</span><br>${last.newPromos} nuevas en ${last.durationSeconds}s</div>` : ''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIGGER MANUAL SCRAPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function triggerScrape() {
  const key = prompt('Ingresa tu ADMIN_API_KEY del servidor:') || ADMIN_KEY;
  if (!key) return;
  localStorage.setItem('cashbackdo_adminkey', key);

  const btn = document.getElementById('scrapeBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  try {
    const res = await fetch(`${API_BASE}/api/scrape`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': key },
      body: JSON.stringify({})
    });
    if (!res.ok) throw new Error('No autorizado');
    showToast('Sistema', 'ğŸ”„ Scraping iniciado en el servidor', 'Los datos se actualizarÃ¡n en unos minutos. Recarga la pÃ¡gina cuando termine.');
    // Poll cada 30s para detectar cuando termina
    const poll = setInterval(async () => {
      try {
        const s = await fetchStats();
        if (s.lastUpdated && Date.now() - new Date(s.lastUpdated) < 120000) {
          clearInterval(poll);
          loadData();
          btn.classList.remove('loading');
          btn.disabled = false;
        }
      } catch {}
    }, 30000);
  } catch (err) {
    alert('Error: ' + err.message);
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEMO_LOCATIONS = [
  { name: 'Bluemall Santo Domingo', area: 'Av. John F. Kennedy, SD', bank: 'Banreservas', promo: 'Descuento los Lunes con Mastercard Banreservas' },
  { name: 'Sportcity', area: 'Santo Domingo', bank: 'Banreservas', promo: 'Beneficios en membresÃ­as con Mastercard Banreservas' },
  { name: 'Arajet.com', area: 'Online / Aeropuerto Las AmÃ©ricas', bank: 'Banreservas', promo: '15% devoluciÃ³n en boletos aÃ©reos con tarjetas Banreservas' },
];

let simLoc = null;

function toggleGeo() {
  geoActive = !geoActive;
  const btn = document.getElementById('geoBtn');
  if (geoActive) {
    btn.textContent = 'ğŸ“ Activo';
    btn.classList.add('active');
    startGeo();
  } else {
    btn.textContent = 'ğŸ“ UbicaciÃ³n';
    btn.classList.remove('active');
    stopGeo();
  }
}

function startGeo() {
  simLoc = DEMO_LOCATIONS[Math.floor(Math.random() * DEMO_LOCATIONS.length)];
  const dot = document.getElementById('pulseDot');
  dot.style.background = 'var(--accent)';
  dot.classList.add('active');
  document.getElementById('locName').textContent = simLoc.name;
  document.getElementById('locSub').textContent = simLoc.area;
  document.getElementById('timerWrap').style.display = 'block';
  document.getElementById('nearbyPromo').style.display = 'none';
  timerSec = 0;
  clearInterval(timerRef);
  timerRef = setInterval(() => {
    timerSec++;
    const m = Math.floor(timerSec / 60), s = timerSec % 60;
    document.getElementById('timerLabel').textContent = `${m}:${s.toString().padStart(2,'0')} / 5:00`;
    document.getElementById('timerFill').style.width = Math.min(timerSec / 300 * 100, 100) + '%';
    if (timerSec === 8) triggerNearby(simLoc); // demo: 8s en vez de 5min
    if (timerSec >= 300) { clearInterval(timerRef); triggerNearby(simLoc); }
  }, 1000);
}

function stopGeo() {
  clearInterval(timerRef);
  document.getElementById('pulseDot').style.background = 'var(--muted)';
  document.getElementById('pulseDot').classList.remove('active');
  document.getElementById('locName').textContent = 'UbicaciÃ³n no activa';
  document.getElementById('locSub').textContent = 'Activa para ver promos cercanas';
  document.getElementById('timerWrap').style.display = 'none';
  document.getElementById('nearbyPromo').style.display = 'none';
  timerSec = 0;
}

function triggerNearby(loc) {
  const np = document.getElementById('nearbyPromo');
  np.style.display = 'block';
  np.innerHTML = `<div style="font-size:0.65rem;font-weight:700;background:var(--accent);color:#000;display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:99px;margin-bottom:8px">ğŸ”” +5 min aquÃ­</div>
    <strong>${loc.bank}</strong> â€” ${loc.promo}`;
  showToast(loc.bank, `Â¡Llevas 5+ min en ${loc.name}!`, loc.promo);
}

function showToast(bank, msg, sub) {
  document.getElementById('toastBank').textContent = bank;
  document.getElementById('toastMsg').textContent = msg;
  document.getElementById('toastSub').textContent = sub || '';
  const t = document.getElementById('notifToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 8000);
}
function closeToast() { document.getElementById('notifToast').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWER / SETTINGS TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleWalletDrawer() {
  const drawer = document.getElementById('walletDrawer');
  const overlay = document.getElementById('drawerOverlay');
  const isOpen = drawer.classList.contains('open');
  closeAllDrawers();
  if (!isOpen) {
    drawer.classList.add('open');
    overlay.classList.add('open');
    document.getElementById('walletBtn').classList.add('active');
  }
}

function toggleSettings() {
  const dd = document.getElementById('settingsDropdown');
  const isOpen = dd.classList.contains('open');
  closeAllDrawers();
  if (!isOpen) {
    dd.classList.add('open');
    document.getElementById('settingsBtn').classList.add('active');
  }
}

function closeAllDrawers() {
  document.getElementById('walletDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('settingsDropdown').classList.remove('open');
  document.getElementById('walletBtn').classList.remove('active');
  document.getElementById('settingsBtn').classList.remove('active');
}

// Close settings dropdown when clicking outside it
document.addEventListener('click', e => {
  const dd = document.getElementById('settingsDropdown');
  const btn = document.getElementById('settingsBtn');
  if (dd.classList.contains('open') && !dd.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
    dd.classList.remove('open');
    btn.classList.remove('active');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API URL CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setApiUrl() {
  const url = document.getElementById('apiUrlInput').value.trim().replace(/\/$/, '');
  if (!url) return;
  API_BASE = url;
  localStorage.setItem('cashbackdo_api', url);
  loadData();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT + AUTO REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData();
fetchCardCatalog();
// Refrescar datos cada 5 minutos automÃ¡ticamente
setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
